# OpenCode ↔ Matrix Bridge - Complete Implementation

**Status**: ✅ **WORKING**

## Summary

Successfully implemented bidirectional communication between OpenCode instances and Matrix/Letta agents via a containerized bridge service.

## Architecture

```
Matrix Room (Letta Agent ↔ OpenCode Identity)
         ↓
   matrix-client monitors rooms
         ↓
   opencode-bridge auto-forwards to registered OpenCode instances
         ↓
   OpenCode SDK injects messages into session context
```

## Key Components

### 1. OpenCode Bridge Service
**Container**: `opencode-bridge`  
**Port**: 3201  
**Location**: `/opt/stacks/matrix-synapse-deployment/opencode-bridge`

**Features**:
- Auto-detects OpenCode identities in Matrix rooms (MXIDs starting with `@oc_`)
- Automatically forwards messages from Letta agents to OpenCode
- Auto-discovers correct session IDs via OpenCode SDK
- Provides `/notify` endpoint for explicit message forwarding
- Port discovery and failover
- Health checks and registration management

**Endpoints**:
- `POST /register` - Register OpenCode instance
- `POST /unregister` - Unregister instance
- `POST /notify` - Explicit message forwarding (used by matrix-mcp)
- `GET /registrations` - List registered instances
- `GET /health` - Health check

### 2. Matrix Messaging MCP
**Container**: `matrix-messaging-mcp`  
**Port**: 3100  
**Location**: `/opt/stacks/matrix-messaging-mcp`

**OpenCode Operations**:
- `opencode_connect` - Connect OpenCode instance to Matrix
- `opencode_send` - Send Matrix message as OpenCode identity
- `opencode_notify` - Send message to OpenCode via bridge
- `opencode_status` - Check OpenCode connection status

## How It Works

### 1. Auto-Forward (Matrix → OpenCode)
When a Letta agent sends a message in a room:
1. `matrix-client` receives the message
2. `opencode-bridge` detects OpenCode member in room (`@oc_*`)
3. Bridge looks up registered OpenCode instance by directory
4. Bridge calls OpenCode SDK to list sessions
5. Bridge finds most recently active session for directory
6. Bridge injects message with `session.prompt({ noReply: true })`
7. Message appears in OpenCode context

### 2. Explicit Forward (Letta → OpenCode)
When a Letta agent explicitly sends to OpenCode:
1. Agent calls `matrix_messaging` tool with `operation: opencode_notify`
2. MCP calls bridge `/notify` endpoint
3. Bridge forwards to registered OpenCode instance
4. Message appears in OpenCode context

### 3. OpenCode → Matrix
When OpenCode wants to send to Letta:
1. OpenCode calls `matrix_messaging` tool with `operation: letta_chat`
2. MCP creates/gets OpenCode Matrix identity
3. MCP sends message as OpenCode identity
4. `matrix-client` routes to Letta agent
5. Letta responds in Matrix room
6. Bridge auto-forwards response back to OpenCode

## Registration

### Manual (Current Method)
```bash
PORT=$(ss -tlnp 2>/dev/null | grep opencode | grep -oP ':\K\d+' | head -1)
curl -X POST http://127.0.0.1:3201/register \
  -H "Content-Type: application/json" \
  -d "{
    \"port\": $PORT,
    \"hostname\": \"127.0.0.1\",
    \"sessionId\": \"auto-discovered\",
    \"directory\": \"$(pwd)\",
    \"rooms\": []
  }"
```

### Automatic (Plugin - In Progress)
**Location**: `.opencode/plugin/matrix-bridge-registration.js`

**Status**: Plugin created but not loading yet. Issue:
- Plugin structure is correct
- Uses proper hooks: `server.connected`, `session.created`, `session.deleted`
- Auto-detects port and derives session ID
- Keep-alive updates every 30s

**Next Step**: Debug why plugin isn't executing. May need to:
- Check plugin loading logs
- Verify export format
- Test with simpler plugin first

## Session ID Discovery

**Critical Learning**: Session IDs must start with `ses_` and are auto-generated by OpenCode.

**Solution**: Bridge now auto-discovers session ID:
```typescript
async function getActiveSessionId(baseUrl: string, directory: string): Promise<string | null> {
  const client = createOpencodeClient({ baseUrl });
  const result = await client.session.list();
  const sessions = result.data
    .filter(s => s.directory === directory)
    .sort((a, b) => b.time.updated - a.time.updated);
  return sessions[0]?.id || null;
}
```

## Testing

### Test Bridge Notification
```bash
curl -X POST http://127.0.0.1:3201/notify \
  -H "Content-Type: application/json" \
  -d '{
    "directory": "/opt/stacks/matrix-synapse-deployment",
    "message": "Test message",
    "sender": "@test:matrix.oculair.ca",
    "agentName": "Test Bot"
  }'
```

### Test via Letta (Meridian)
Use matrix-mcp tool:
```json
{
  "operation": "opencode_notify",
  "directory": "/opt/stacks/matrix-synapse-deployment",
  "message": "Hello from Meridian!",
  "display_name": "Meridian"
}
```

## Current Status

✅ **Working**:
- Bridge auto-discovers session IDs
- Manual registration works
- Auto-forward from Matrix rooms works
- Explicit notify endpoint works
- Messages successfully injected into OpenCode context
- No errors in bridge logs

⚠️ **Partial**:
- Plugin created but not loading (manual registration required)

## Files Changed

### Created
- `/opt/stacks/matrix-synapse-deployment/opencode-bridge/` - Bridge service
- `/opt/stacks/matrix-synapse-deployment/.opencode/plugin/matrix-bridge-registration.js` - Auto-registration plugin
- `/opt/stacks/matrix-synapse-deployment/docker/Dockerfile.opencode-bridge` - Container image

### Modified
- `docker-compose.yml` - Added opencode-bridge service
- `.env` - Added `OPENCODE_BRIDGE_ACCESS_TOKEN`

## Next Steps

1. **Debug plugin loading** - Figure out why auto-registration plugin isn't executing
2. **Test full loop** - Meridian → OpenCode → Response → Meridian
3. **Document MCP usage** - Add examples for Letta agents
4. **Add monitoring** - Track message counts, failures, latency

## Environment Variables

```bash
OPENCODE_BRIDGE_ACCESS_TOKEN=<matrix_bot_token>
OPENCODE_BRIDGE_URL=http://127.0.0.1:3201  # For MCP to reach bridge
```

## Docker Services

```yaml
opencode-bridge:
  build:
    context: .
    dockerfile: docker/Dockerfile.opencode-bridge
  network_mode: host  # Required to access localhost OpenCode instances
  environment:
    - MATRIX_HOMESERVER_URL=http://127.0.0.1:6167
    - MATRIX_ACCESS_TOKEN=${OPENCODE_BRIDGE_ACCESS_TOKEN}
  healthcheck:
    test: ["CMD", "wget", "--spider", "-q", "http://localhost:3201/health"]
    interval: 30s
    timeout: 10s
    retries: 3
```

## Known Issues

1. **Plugin not loading** - Manual registration required every 60s (stale timeout)
2. **MCP session errors** - matrix-mcp shows "No connection established" errors (harmless, MCP protocol quirk)

## Success Metrics

✅ Test message received: "Testing auto-discovery of session ID!"  
✅ Session auto-discovered: `ses_5397186f3ffe2y5n519cnCT9K2`  
✅ Bridge logs show successful forwarding  
✅ No errors in OpenCode output  

## Conclusion

The bridge is **fully functional** for forwarding Matrix messages to OpenCode. The only remaining work is debugging the plugin to eliminate manual registration.
