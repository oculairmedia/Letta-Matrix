# Room Recreation Issue & Solution

## Problem

Rooms are being recreated with new IDs, breaking the agent routing mappings.

**Symptoms:**
- Agent says it's "letta code" when it should be "Meridian"
- Database has old room ID: `!i0zsq9TSdXJunUZq00:matrix.oculair.ca`
- Actual messages come from: `!O8cbkBGCMB8Ujlaret:matrix.oculair.ca`
- Logs show "No agent mapping found in DB"

## Root Cause

Matrix room IDs are **randomly generated by the homeserver** and cannot be specified. When rooms are recreated (deleted and recreated), they get new IDs, which breaks database mappings.

## Immediate Fix (Manual)

Update the database mapping to the new room:

```bash
docker exec matrix-synapse-deployment-matrix-client-1 python3 -c "
from src.models.agent_mapping import AgentMappingDB

db = AgentMappingDB()

# Update Meridian to new room
db.update(
    'agent-597b5756-2915-4560-ba6b-91005f085166',  # Meridian agent ID
    room_id='!O8cbkBGCMB8Ujlaret:matrix.oculair.ca'  # New room ID
)

print('âœ… Updated Meridian room mapping')
"
```

## Long-Term Solutions

### Option 1: Room Alias-Based Routing (Recommended)

Use room aliases instead of room IDs for routing.

**Advantages:**
- Aliases are human-readable: `#meridian:matrix.oculair.ca`
- Aliases are stable (don't change when room is recreated)
- Aliases can embed agent ID: `#agent-597b5756:matrix.oculair.ca`

**Implementation:**
1. Create room with alias during setup
2. Route based on alias instead of room ID
3. Fall back to room members if no alias

### Option 2: Room Member-Based Routing

Extract agent ID from room members.

**How it works:**
- Each agent has a Matrix user: `@agent_UUID:matrix.oculair.ca`
- When message arrives, check room members
- If an agent user is in the room, route to that agent

**Advantages:**
- Self-healing: Works even if room is recreated
- No database dependency for routing
- Works with any room structure

**Implementation:**
```python
# Get room members
members = await client.joined_members(room_id)

# Find agent user in members
for member in members.values():
    if member.user_id.startswith('@agent_'):
        # Extract agent ID from user ID
        agent_id = extract_agent_id_from_user(member.user_id)
        return agent_id
```

### Option 3: Prevent Room Deletion

Stop rooms from being deleted/recreated.

**Implementation:**
- Add room state validation before recreation
- Check if room exists and is valid before creating new one
- Update existing room instead of recreating

## Prevention Strategies

### 1. Room Creation Safeguards

```python
async def create_or_update_agent_room(agent_id, mapping):
    # Check if room exists and agent is member
    if mapping.room_id:
        try:
            room_valid = await check_room_exists(mapping.room_id)
            agent_is_member = await check_agent_in_room(mapping.room_id, mapping.matrix_user_id)
            
            if room_valid and agent_is_member:
                logger.info(f"Room {mapping.room_id} is valid, reusing")
                return mapping.room_id
        except Exception as e:
            logger.warning(f"Room validation failed: {e}")
    
    # Only create new room if necessary
    return await create_new_room(agent_id, mapping)
```

### 2. Database Sync on Room Events

Listen for room events and update database:

```python
async def on_room_member(room, event):
    # When agent joins a new room, update database
    if event.membership == "join" and is_agent_user(event.state_key):
        agent_id = extract_agent_id(event.state_key)
        
        # Update database with new room
        db.update(agent_id, room_id=room.room_id)
        logger.info(f"Auto-updated {agent_id} to room {room.room_id}")
```

### 3. Periodic Database Reconciliation

Run a cron job to sync database with actual Matrix state:

```python
async def reconcile_room_mappings():
    db = AgentMappingDB()
    
    for mapping in db.get_all():
        # Check if agent user is in a different room
        actual_rooms = await find_rooms_with_user(mapping.matrix_user_id)
        
        if mapping.room_id not in actual_rooms:
            # Agent is in a different room, update database
            if actual_rooms:
                new_room = actual_rooms[0]
                db.update(mapping.agent_id, room_id=new_room)
                logger.warning(f"Reconciled {mapping.agent_name}: {mapping.room_id} -> {new_room}")
```

## Implementation Plan

### Phase 1: Quick Fix (Immediate)
- [x] Manual database updates when rooms change
- [x] Enhanced logging to detect room mismatches

### Phase 2: Member-Based Routing (This Week)
- [ ] Implement room member lookup
- [ ] Extract agent ID from member list
- [ ] Fall back to database if member lookup fails

### Phase 3: Alias-Based Routing (Next Week)
- [ ] Create room aliases during setup
- [ ] Route based on alias first
- [ ] Update room creation to always set alias

### Phase 4: Auto-Reconciliation (Future)
- [ ] Listen for room membership events
- [ ] Auto-update database on room changes
- [ ] Periodic reconciliation job

## Monitoring

### Detect Room Mismatches

```bash
# Check for routing failures
docker logs matrix-synapse-deployment-matrix-client-1 2>&1 | \
  grep "No agent mapping found in DB" | \
  tail -20
```

### Verify Database Mappings

```bash
docker exec matrix-synapse-deployment-matrix-client-1 python3 /app/sync_mappings_to_db.py --verify
```

### Find Rooms Without Mappings

```python
# List all rooms that have no database mapping
async def find_unmapped_rooms():
    db = AgentMappingDB()
    mapped_rooms = {m.room_id for m in db.get_all()}
    
    # Get all joined rooms
    all_rooms = await client.rooms
    
    unmapped = [room for room in all_rooms if room.room_id not in mapped_rooms]
    
    for room in unmapped:
        print(f"Unmapped room: {room.room_id}")
        print(f"  Name: {room.display_name}")
        print(f"  Members: {len(room.users)}")
```

## Related Issues

- Agent routing fails after room recreation
- "letta code" responds instead of correct agent
- Database has stale room IDs
- Rooms mysteriously change IDs

## See Also

- [AGENT_MAPPING_SYNC.md](./AGENT_MAPPING_SYNC.md) - Database sync procedures
- [ROOM_MAPPING_INTEGRITY_FIX.md](./ROOM_MAPPING_INTEGRITY_FIX.md) - Room validation
- [Testing Strategy](./TESTING_STRATEGY.md) - Integration tests
