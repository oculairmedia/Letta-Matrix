# Agent Mail <-> Matrix Bridge

Bidirectional bridge that connects MCP Agent Mail with Matrix, enabling:
- **Dev agents** to work natively with Agent Mail for file coordination
- **All messages** to be bridged into Matrix for human visibility
- **Single source of truth** for agent identities (Matrix)

## Architecture

```
Matrix Rooms ‚Üê‚Üí Bridge Service ‚Üê‚Üí MCP Agent Mail Server
     ‚Üì                                    ‚Üì
  Element UI                    OpenCode, Letta Code, etc.
```

### Message Flow

**Agent Mail ‚Üí Matrix:**
- Bridge polls Agent Mail inboxes every 30 seconds
- New messages forwarded to agent's Matrix room
- Formatted as notices (m.notice) to distinguish from agent messages
- File reservation conflicts highlighted with warnings

**Matrix ‚Üí Agent Mail:**
- Bridge listens to all agent rooms
- Dev-related messages (containing keywords like "file", "reserve", "commit") forwarded to Agent Mail
- Sent from "MatrixBridge" user in Agent Mail

## Setup

### 1. Generate Identity Mapping

```bash
cd /opt/stacks/matrix-synapse-deployment
python3 scripts/generate_identity_mapping.py
```

This creates `matrix_client_data/agent_mail_mappings.json` mapping:
- Letta agent_id ‚Üî Agent Mail name
- Matrix user_id ‚Üî Agent Mail name
- Matrix room_id ‚Üî Agent Mail project

### 2. Register Bridge User

```bash
./scripts/setup_agent_mail_bridge.sh
```

This:
- Creates `@agent_mail_bridge:matrix.oculair.ca` user
- Obtains access token
- Joins all agent rooms
- Saves credentials to `.env`

### 3. Deploy Bridge Service

```bash
docker compose up -d agent-mail-bridge
```

### 4. Verify

```bash
# Check bridge logs
docker logs -f agent-mail-bridge

# Should see:
# - "Starting Agent Mail <-> Matrix Bridge"
# - "Loaded X agent identities"
# - "Connecting to Matrix as @agent_mail_bridge:..."
# - "Joined room !..."
# - "Bridge service started successfully"
```

## Configuration

Environment variables in `.env`:

```bash
# Bridge user credentials (auto-generated by setup script)
AGENT_MAIL_BRIDGE_USER_ID=@agent_mail_bridge:matrix.oculair.ca
AGENT_MAIL_BRIDGE_ACCESS_TOKEN=syt_...

# Agent Mail server URL
AGENT_MAIL_URL=http://192.168.50.90:8766/mcp/

# Poll interval (seconds between inbox checks)
AGENT_MAIL_POLL_INTERVAL=30
```

## Identity Mapping

### Name Conversion Rules

Matrix names are sanitized for Agent Mail compatibility:

| Matrix Name | Agent Mail Name |
|-------------|-----------------|
| `Huly - Matrix Synapse Deployment` | `HulyMatrixSynapse` |
| `BMO` | `BMO` |
| `Meridian` | `Meridian` |
| `GraphitiExplorer` | `GraphitiExplorer` |
| `letta-cli-agent` | `Lettacliagent` |

Rules:
- Remove special characters
- CamelCase words
- Max 3 words (keeps names short)
- Duplicates get numeric suffix

### Mapping File Format

`matrix_client_data/agent_mail_mappings.json`:

```json
{
  "agent-870d3dfb-319f-4c52-91f1-72ab46d944a7": {
    "matrix_user_id": "@agent_870d3dfb_...:matrix.oculair.ca",
    "matrix_room_id": "!MtuqLUCwvKypRU6gll:matrix.oculair.ca",
    "matrix_name": "Huly - Matrix Synapse Deployment",
    "agent_mail_name": "HulyMatrixSynapse",
    "agent_mail_registered": false,
    "last_sync": "2025-12-24T18:00:00Z"
  }
}
```

## Message Examples

### File Reservation Conflict

**Agent Mail message:**
```
From: AgentMailSystem
Subject: File Reservation Conflict
Importance: high

OpenCode attempted to reserve `src/api/endpoints.py` but you 
(HulyMatrixSynapse) currently hold the reservation.

Expires: 2025-12-24 10:30 UTC
```

**Appears in Matrix as:**
```
üì¨ Agent Mail Message

From: AgentMailSystem
Subject: File Reservation Conflict
Importance: ‚ö†Ô∏è high
Time: 2025-12-24T09:45:00Z

OpenCode attempted to reserve `src/api/endpoints.py` but you 
(HulyMatrixSynapse) currently hold the reservation.

Expires: 2025-12-24 10:30 UTC
```

### Human Intervention

**Human types in Matrix (Meridian's room):**
```
@agent_597b5756 please release your file reservations on src/api/, 
I need to make an urgent hotfix
```

**Bridge detects keywords and forwards to Agent Mail:**
```
From: MatrixBridge
To: Meridian
Subject: Message from @admin
Body: @agent_597b5756 please release your file reservations...
```

## Auto-Registration

When bridge starts:
1. Loads identity mapping
2. For each agent, checks if registered in Agent Mail
3. If not, calls `register_agent` tool with:
   - `project_key`: `/opt/stacks/matrix-synapse-deployment`
   - `name`: Agent Mail name from mapping
   - `program`: `"letta"`
   - `task_description`: Matrix agent name

## Message Filtering

### Dev Message Keywords

Messages containing these keywords get forwarded Matrix ‚Üí Agent Mail:
- `file`, `reserve`, `reservation`, `conflict`
- `edit`, `commit`, `push`, `pull`, `merge`
- `lock`, `unlock`, `coordinate`, `working on`
- `blocked`, `lease`, `claim`

### Message Types

**Agent Mail ‚Üí Matrix:**
- All messages forwarded (no filtering)
- Formatted as `m.notice` (distinguishable in clients)
- Markdown converted to HTML for rich display

**Matrix ‚Üí Agent Mail:**
- Only dev-related messages forwarded
- Avoids flooding Agent Mail with off-topic chat

## Monitoring

### Health Checks

```bash
# Bridge health
docker inspect agent-mail-bridge --format='{{.State.Health.Status}}'

# Recent logs
docker logs --tail 50 agent-mail-bridge
```

### Metrics to Watch

- **Inbox poll frequency**: Should be every ~30 seconds
- **Message forwarding**: Check both directions working
- **Room membership**: Bridge should be in all agent rooms
- **Agent registration**: All agents should be registered in Agent Mail

### Troubleshooting

**Bridge not joining rooms:**
```bash
# Check token validity
curl -X GET http://localhost:6167/_matrix/client/v3/account/whoami \
  -H "Authorization: Bearer $AGENT_MAIL_BRIDGE_ACCESS_TOKEN"

# Re-run setup script
./scripts/setup_agent_mail_bridge.sh
```

**Messages not forwarding:**
```bash
# Check Agent Mail server is accessible
curl http://192.168.50.90:8766/mcp/

# Check bridge can reach Agent Mail
docker exec agent-mail-bridge curl -s http://192.168.50.90:8766/mcp/
```

**Agent registration failing:**
```bash
# Check identity mapping
cat matrix_client_data/agent_mail_mappings.json | jq 'to_entries | .[0]'

# Manually register an agent
curl -X POST http://192.168.50.90:8766/mcp/ \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": "test",
    "method": "tools/call",
    "params": {
      "name": "register_agent",
      "arguments": {
        "project_key": "/opt/stacks/matrix-synapse-deployment",
        "program": "letta",
        "model": "unknown",
        "name": "TestAgent"
      }
    }
  }'
```

## Development

### Running Locally

```bash
cd /opt/stacks/matrix-synapse-deployment

# Set environment
export MATRIX_HOMESERVER_URL=http://localhost:6167
export MATRIX_USER_ID=@agent_mail_bridge:matrix.oculair.ca
export MATRIX_ACCESS_TOKEN=...
export AGENT_MAIL_URL=http://localhost:8766/mcp/
export DATA_DIR=./matrix_client_data

# Run bridge
python3 -m src.bridges.agent_mail_bridge
```

### Testing Message Flow

**Test Agent Mail ‚Üí Matrix:**
```python
# Send test message in Agent Mail
curl -X POST http://localhost:8766/mcp/ -H "Content-Type: application/json" -d '{
  "jsonrpc": "2.0",
  "id": "test",
  "method": "tools/call",
  "params": {
    "name": "send_message",
    "arguments": {
      "project_key": "/opt/stacks/matrix-synapse-deployment",
      "sender_name": "TestSender",
      "to": ["HulyMatrixSynapse"],
      "subject": "Test Message",
      "body_md": "This is a test message from Agent Mail",
      "importance": "high"
    }
  }
}'

# Should appear in Matrix room within 30 seconds
```

**Test Matrix ‚Üí Agent Mail:**
```bash
# Send dev-related message to agent's Matrix room
# Should be forwarded to Agent Mail and visible in inbox
```

## Architecture Details

### Bridge Components

1. **Identity Mapper**: Maintains bidirectional Letta ‚Üî Matrix ‚Üî Agent Mail mappings
2. **Inbox Poller**: Polls Agent Mail inboxes every 30 seconds
3. **Message Formatter**: Converts Agent Mail messages to Matrix format
4. **Matrix Listener**: Monitors all agent rooms for dev messages
5. **Message Forwarder**: Sends filtered Matrix messages to Agent Mail

### State Management

- **Identity mapping**: Loaded on startup, persisted to JSON
- **Last poll times**: In-memory per agent (lost on restart)
- **Processed messages**: In-memory set (prevents duplicates during session)
- **Agent registration**: Cached in mapping file (persists restarts)

### Concurrency

- **Two async tasks** run concurrently:
  1. Agent Mail inbox polling loop
  2. Matrix sync loop (listens for messages)
- Both use `asyncio` for non-blocking I/O
- HTTP requests use `httpx.AsyncClient`
- Matrix client uses `nio.AsyncClient`

## Files

```
/opt/stacks/matrix-synapse-deployment/
‚îú‚îÄ‚îÄ src/bridges/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ agent_mail_bridge.py           # Bridge service implementation
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ generate_identity_mapping.py   # Generate mapping from Matrix data
‚îÇ   ‚îî‚îÄ‚îÄ setup_agent_mail_bridge.sh     # Register bridge user in Matrix
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile.agent-mail-bridge   # Container image
‚îú‚îÄ‚îÄ matrix_client_data/
‚îÇ   ‚îú‚îÄ‚îÄ agent_user_mappings.json       # Matrix agent data (source of truth)
‚îÇ   ‚îî‚îÄ‚îÄ agent_mail_mappings.json       # Generated identity mapping
‚îî‚îÄ‚îÄ docker-compose.yml                 # Bridge service definition
```

## Benefits

### For Dev Agents
- Native Agent Mail integration
- File coordination without conflicts
- Platform-specific tooling (OpenCode, Letta Code, etc.)

### For Letta Agents
- Everything visible in Matrix
- No duplicate registration
- Familiar interface

### For Humans
- Single interface (Element)
- Real-time visibility
- Can intervene via Matrix

### For the System
- Matrix is source of truth
- Automatic synchronization
- Clear separation of concerns
- Scalable architecture
