version: '3.8'

services:
  matrix-messaging-mcp:
    build: .
    container_name: matrix-messaging-mcp
    restart: unless-stopped
    
    environment:
      # Matrix Configuration
      MATRIX_HOMESERVER_URL: ${MATRIX_HOMESERVER_URL:-https://matrix.oculair.ca}
      MATRIX_ADMIN_TOKEN: ${MATRIX_ADMIN_TOKEN}
      MATRIX_SERVER_NAME: ${MATRIX_SERVER_NAME:-matrix.oculair.ca}
      MATRIX_ADMIN_USERNAME: ${MATRIX_ADMIN_USERNAME:-@admin:matrix.oculair.ca}
      MATRIX_ADMIN_PASSWORD: ${MATRIX_ADMIN_PASSWORD:-}
      
      # MCP Server Configuration  
      PORT: ${MCP_SERVER_PORT:-3100}
      
      # Storage
      DATA_DIR: /app/data
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Letta Integration
      LETTA_API_URL: ${LETTA_API_URL:-}
      LETTA_API_TOKEN: ${LETTA_API_TOKEN:-}
      
      # Cross-Run Tracking Configuration
      WEBHOOK_PORT: ${WEBHOOK_PORT:-3101}
      CONVERSATION_TIMEOUT_SECONDS: ${CONVERSATION_TIMEOUT_SECONDS:-300}
      MAX_RESPONSE_WAIT: ${MAX_RESPONSE_WAIT:-60}
      RESPONSE_POLL_INTERVAL: ${RESPONSE_POLL_INTERVAL:-2}
    
    ports:
      - "${MCP_SERVER_PORT:-3100}:3100"
      - "${WEBHOOK_PORT:-3101}:3101"
    
    volumes:
      # Persistent data storage
      - ./data:/app/data
      # Optional: Mount client storage separately
      - ./data/clients:/app/data/clients
    
    networks:
      - matrix-mcp-net
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  matrix-mcp-net:
    driver: bridge
