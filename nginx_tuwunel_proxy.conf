# =============================================================================
# Performance: Gzip compression (60-80% size reduction for text assets)
# =============================================================================
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml
    font/woff2
    application/wasm;

# =============================================================================
# Performance: Proxy cache for Element static assets
# =============================================================================
proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=element_cache:10m
    max_size=100m inactive=7d use_temp_path=off;

server {
    # HTTP listener
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name matrix.oculair.ca _;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;
    set $proto $scheme;
    if ($http_x_forwarded_proto) {
        set $proto $http_x_forwarded_proto;
    }
    # Well-known for Matrix client discovery (includes MatrixRTC/LiveKit config)
    location /.well-known/matrix/client {
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "X-Requested-With, Content-Type, Authorization";
        return 200 '{
            "m.homeserver": {
                "base_url": "https://matrix.oculair.ca"
            },
            "org.matrix.msc4143.rtc_foci": [
                {
                    "type": "livekit",
                    "livekit_service_url": "https://matrix.oculair.ca/livekit/jwt"
                }
            ]
        }';
    }

    # Well-known for server discovery (federation)
    location /.well-known/matrix/server {
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        return 200 '{"m.server": "matrix.oculair.ca:443"}';
    }

    # ── MatrixRTC endpoint routing (MSC4195) ─────────────────────────
    # JWT auth service for LiveKit tokens
    location ^~ /livekit/jwt/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proto;
        proxy_pass http://lk-jwt-service:8080/;
    }

    # LiveKit SFU WebSocket signalling
    location ^~ /livekit/sfu/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proto;

        proxy_send_timeout 120;
        proxy_read_timeout 120;
        proxy_buffering off;

        proxy_set_header Accept-Encoding gzip;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_pass http://livekit:7880/;
    }

    # Matrix client and server API endpoints
    location ~ ^(/_matrix|/_synapse/client) {
        proxy_pass http://tuwunel:6167;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proto;
        proxy_set_header Host $http_host;

        client_max_body_size 50M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
    }

    # Element static assets - cache aggressively (content-hashed filenames)
    location ~* \.(js|css|woff|woff2|ttf|eot|svg|png|jpg|gif|ico|map|wasm)$ {
        proxy_pass http://element:80;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;

        # Override upstream cache headers
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Cache-Status $upstream_cache_status;

        # Proxy cache - avoid hitting element container on repeat requests
        proxy_cache element_cache;
        proxy_cache_valid 200 7d;
        proxy_cache_use_stale error timeout updating;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Element web client - HTML/config (short cache for fast deployments)
    location / {
        proxy_pass http://element:80;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;

        # Short cache for HTML - pick up new deployments within 5 minutes
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=300, must-revalidate";

        client_max_body_size 50M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
# Federation port (SSL handled by Cloudflare tunnel)
server {
    listen 8448 default_server;
    listen [::]:8448 default_server;
    server_name matrix.oculair.ca;

    location ~ ^(/_matrix|/_synapse/client) {
        proxy_pass http://tuwunel:6167;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $http_host;

        client_max_body_size 50M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
    }
}
