services:
  tuwunel:
    image: ghcr.io/oculairmedia/tuwunel-docker2010:latest
    restart: unless-stopped
    command: ["-c", "/var/lib/tuwunel/tuwunel.toml", "-O", "address=\"0.0.0.0\"", "-O", "port=6167"]
    environment:
      - TUWUNEL_SERVER_NAME=${MATRIX_SERVER_NAME:-matrix.oculair.ca}
      - TUWUNEL_DATABASE_PATH=/var/lib/tuwunel
      - TUWUNEL_ALLOW_REGISTRATION=true
      - TUWUNEL_REGISTRATION_TOKEN=${MATRIX_REGISTRATION_TOKEN}
      - TUWUNEL_MAX_REQUEST_SIZE=20000000
      - TUWUNEL_ALLOW_FEDERATION=true
      - TUWUNEL_ALLOW_CHECK_FOR_UPDATES=true
      - TUWUNEL_TRUSTED_SERVERS=["matrix.org"]
      - TUWUNEL_LOG=info
    volumes:
      - ${TUWUNEL_DATA_PATH:-./tuwunel-data}:/var/lib/tuwunel
    networks:
      - matrix-internal
    ports:
      - "6167:6167"
    healthcheck:
      test:
        - CMD
        - wget
        - --spider
        - -q
        - http://localhost:6167/_matrix/client/versions
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  element:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ${ELEMENT_CONFIG_PATH}:/app/config.json:ro
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - ${NGINX_HTTP_PORT}:80
    volumes:
      - ${NGINX_CONFIG_PATH}:/etc/nginx/conf.d/default.conf:ro
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
      element:
        condition: service_started
    labels:
      - homepage.group=Communication
      - homepage.name=Matrix Homeserver (Tuwunel)
      - homepage.icon=si-matrix
      - homepage.href=http://matrix.oculair.ca
      - homepage.description=Tuwunel Matrix homeserver with Element web client
  matrix-client:
    image: ghcr.io/oculairmedia/letta-matrix-client:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - DATABASE_URL=postgresql://letta:letta@192.168.50.90:5432/matrix_letta
      - CONVERSATION_TRACKER_URL=http://192.168.50.90:3101
    volumes:
      - ./matrix_store:/app/matrix_store
      - ./matrix_client_data:/app/data
      - ./src:/app/src:ro # Mount source code for development
      - ./custom_matrix_client.py:/app/custom_matrix_client.py:ro
      - ./agent_user_manager.py:/app/agent_user_manager.py:ro
      - ./matrix_auth.py:/app/matrix_auth.py:ro
      - ./event_dedupe_store.py:/app/event_dedupe_store.py:ro
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
      matrix-api:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import sys; sys.exit(0)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  matrix-api:
    image: ghcr.io/oculairmedia/letta-matrix-api:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - DATABASE_URL=postgresql://letta:letta@192.168.50.90:5432/matrix_letta
    volumes:
      - ./matrix_client_data:/app/data
      - ./src:/app/src:ro
    ports:
      - 8004:8000
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
    labels:
      - homepage.group=Communication
      - homepage.name=Matrix API
      - homepage.icon=si-api
      - homepage.href=http://192.168.50.90:8004
      - homepage.description=Matrix API server for automation

  letta-agent-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.letta-agent-mcp
    image: letta-matrix-mcp:local
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_API_URL=http://matrix-api:8000
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - LETTA_API_URL=http://192.168.50.90:8289
      - LETTA_AGENT_MCP_HOST=0.0.0.0
      - LETTA_AGENT_MCP_PORT=8017
    ports:
      - 8017:8017
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
      matrix-api:
        condition: service_started
      matrix-client:
        condition: service_started
      opencode-bridge:
        condition: service_healthy
    volumes:
      - ./matrix_client_data:/app/data
    labels:
      - homepage.group=Communication
      - homepage.name=Letta Agent MCP
      - homepage.icon=si-chat
      - homepage.href=http://192.168.50.90:8017
      - homepage.description=Inter-agent communication MCP server
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import urllib.request;
          urllib.request.urlopen('http://localhost:8017/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  opencode-bridge:
    image: ghcr.io/oculairmedia/letta-matrix-opencode-bridge:latest
    restart: unless-stopped
    ports:
      - 3201:3201
    network_mode: host
    environment:
      - MATRIX_HOMESERVER_URL=http://127.0.0.1:6167
      - MATRIX_ACCESS_TOKEN=${OPENCODE_BRIDGE_ACCESS_TOKEN}
      - BRIDGE_PORT=3201
      - AGENT_MAPPINGS_PATH=/app/data/agent_user_mappings.json
    volumes:
      - ./matrix_client_data:/app/data
      - ./opencode-bridge/dist:/app/dist:ro  # Mount local builds for development
    depends_on:
      tuwunel:
        condition: service_healthy
    labels:
      - homepage.group=Communication
      - homepage.name=OpenCode Matrix Bridge
      - homepage.icon=si-matrix
      - homepage.href=http://192.168.50.90:3201
      - homepage.description=Forwards Matrix messages to OpenCode instances
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:3201/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  matrix-messaging-mcp:
    build:
      context: ./mcp-servers/matrix-identity-bridge
      dockerfile: Dockerfile
    image: matrix-identity-bridge:local
    container_name: matrix-messaging-mcp
    restart: unless-stopped
    ports:
      - "3100:3100"
      - "3101:3101"
    environment:
      # Matrix Configuration
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - MATRIX_SERVER_NAME=${MATRIX_SERVER_NAME:-matrix.oculair.ca}
      - MATRIX_ADMIN_USERNAME=${MATRIX_ADMIN_USERNAME:-@admin:matrix.oculair.ca}
      - MATRIX_ADMIN_PASSWORD=${MATRIX_ADMIN_PASSWORD}
      # MCP Server Configuration
      - PORT=3100
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Letta Integration
      - LETTA_API_URL=${LETTA_API_URL:-http://192.168.50.90:8283}
      - LETTA_API_KEY=${LETTA_API_KEY}
      # Cross-Run Tracking Configuration
      - WEBHOOK_PORT=3101
      - CONVERSATION_TIMEOUT_SECONDS=${CONVERSATION_TIMEOUT_SECONDS:-300}
      - MAX_RESPONSE_WAIT=${MAX_RESPONSE_WAIT:-60}
      - RESPONSE_POLL_INTERVAL=${RESPONSE_POLL_INTERVAL:-2}
    volumes:
      - ./mcp-servers/matrix-identity-bridge/data:/app/data
    networks:
      - matrix-internal
    depends_on:
      tuwunel:
        condition: service_healthy
    labels:
      - homepage.group=Communication
      - homepage.name=Matrix Messaging MCP
      - homepage.icon=si-matrix
      - homepage.href=http://192.168.50.90:3100
      - homepage.description=Matrix identity bridge MCP with Letta integration and cross-run tracking
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3101/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
networks:
  matrix-internal:
    driver: bridge
