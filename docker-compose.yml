services:
  element:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ${ELEMENT_CONFIG_PATH}:/app/config.json:ro
    networks:
      - matrix-internal
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - ${NGINX_HTTP_PORT}:80
    volumes:
      - ${NGINX_CONFIG_PATH}:/etc/nginx/conf.d/default.conf:ro
    networks:
      - matrix-internal
    depends_on:
      - element
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix Homeserver (Tuwunel)"
      - "homepage.icon=si-matrix"
      - "homepage.href=http://matrix.oculair.ca"
      - "homepage.description=Tuwunel Matrix homeserver with Element web client"
  matrix-client:
    image: ghcr.io/oculairmedia/letta-matrix-client:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - DATABASE_URL=postgresql://letta:letta@192.168.50.90:5432/matrix_letta
    volumes:
      - ./matrix_store:/app/matrix_store
      - ./matrix_client_data:/app/data
      - ./src:/app/src:ro  # Mount source code for development
      - ./custom_matrix_client.py:/app/custom_matrix_client.py:ro
      - ./agent_user_manager.py:/app/agent_user_manager.py:ro
      - ./matrix_auth.py:/app/matrix_auth.py:ro
      - ./event_dedupe_store.py:/app/event_dedupe_store.py:ro
    networks:
      - matrix-internal
    depends_on:
      matrix-api:
        condition: service_started
      mcp-server:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import sys; sys.exit(0)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  matrix-api:
    image: ghcr.io/oculairmedia/letta-matrix-api:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
    volumes:
      - ./matrix_client_data:/app/data
    ports:
      - 8004:8000
    networks:
      - matrix-internal
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix API"
      - "homepage.icon=si-api"
      - "homepage.href=http://192.168.50.90:8004"
      - "homepage.description=Matrix API server for automation"
  mcp-server:
    image: ghcr.io/oculairmedia/letta-matrix-mcp:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_API_URL=http://matrix-api:8000
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8005
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PORT=8006
    ports:
      - 8015:8005 # WebSocket port (host:container)
      - 8016:8006 # HTTP streaming port (host:container)
    networks:
      - matrix-internal
    depends_on:
      - matrix-api
    volumes:
      - ./mcp_data:/app/data
      - ./src/mcp/http_server.py:/app/src/mcp/http_server.py:ro
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix MCP Server"
      - "homepage.icon=si-websocket"
      - "homepage.href=http://192.168.50.90:8016"
      - "homepage.description=Matrix MCP server for Claude integration"
  letta-agent-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.letta-agent-mcp
    image: letta-matrix-mcp:local
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_API_URL=http://matrix-api:8000
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - LETTA_API_URL=http://192.168.50.90:8289
      - LETTA_AGENT_MCP_HOST=0.0.0.0
      - LETTA_AGENT_MCP_PORT=8017
    ports:
      - 8017:8017
    networks:
      - matrix-internal
    depends_on:
      - matrix-api
      - matrix-client
    volumes:
      - ./matrix_client_data:/app/data
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Letta Agent MCP"
      - "homepage.icon=si-chat"
      - "homepage.href=http://192.168.50.90:8017"
      - "homepage.description=Inter-agent communication MCP server"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8017/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  opencode-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.opencode-bridge
    image: opencode-matrix-bridge:local
    restart: unless-stopped
    network_mode: host
    environment:
      - MATRIX_HOMESERVER_URL=http://127.0.0.1:6167
      - MATRIX_ACCESS_TOKEN=${OPENCODE_BRIDGE_ACCESS_TOKEN}
      - BRIDGE_PORT=3201
      - AGENT_MAPPINGS_PATH=/app/data/agent_user_mappings.json
    volumes:
      - ./matrix_client_data:/app/data
    labels:
      - "homepage.group=Communication"
      - "homepage.name=OpenCode Matrix Bridge"
      - "homepage.icon=si-matrix"
      - "homepage.href=http://192.168.50.90:3201"
      - "homepage.description=Forwards Matrix messages to OpenCode instances"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3201/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  matrix-messaging-mcp:
    build:
      context: /opt/stacks/matrix-messaging-mcp
      dockerfile: /opt/stacks/matrix-synapse-deployment/docker/Dockerfile.matrix-mcp
    image: matrix-messaging-mcp:local
    restart: unless-stopped
    network_mode: host
    environment:
      - MATRIX_HOMESERVER_URL=http://127.0.0.1:6167
      - MATRIX_REGISTRATION_TOKEN=${MATRIX_REGISTRATION_TOKEN}
      - LETTA_API_URL=${LETTA_API_URL:-http://127.0.0.1:8283}
      - LETTA_API_KEY=${LETTA_API_KEY}
      - LETTA_API_TOKEN=${LETTA_TOKEN}
      - OPENCODE_BRIDGE_URL=http://127.0.0.1:3201
      - MCP_SERVER_PORT=3100
      - MCP_SERVER_HOST=0.0.0.0
      - DATA_DIR=/app/data
    volumes:
      - /opt/stacks/matrix-messaging-mcp/data:/app/data
      - ./matrix_client_data:/app/matrix_data:ro
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix Messaging MCP"
      - "homepage.icon=si-matrix"
      - "homepage.href=http://192.168.50.90:3100"
      - "homepage.description=Universal Matrix messaging MCP with Letta and OpenCode integration"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node dist/index.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
networks:
  matrix-internal:
    driver: bridge
