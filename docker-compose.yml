services:
  element:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ${ELEMENT_CONFIG_PATH}:/app/config.json:ro
    networks:
      - matrix-internal
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - ${NGINX_HTTP_PORT}:80
    volumes:
      - ${NGINX_CONFIG_PATH}:/etc/nginx/conf.d/default.conf:ro
    networks:
      - matrix-internal
    depends_on:
      - element
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix Homeserver (Tuwunel)"
      - "homepage.icon=si-matrix"
      - "homepage.href=http://matrix.oculair.ca"
      - "homepage.description=Tuwunel Matrix homeserver with Element web client"
  matrix-client:
    image: letta-matrix-client:local
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - DATABASE_URL=postgresql://letta:letta@192.168.50.90:5432/matrix_letta
    volumes:
      - ./matrix_store:/app/matrix_store
      - ./matrix_client_data:/app/data
      - ./src:/app/src:ro  # Mount source code for development
      - ./custom_matrix_client.py:/app/custom_matrix_client.py:ro
      - ./agent_user_manager.py:/app/agent_user_manager.py:ro
      - ./matrix_auth.py:/app/matrix_auth.py:ro
      - ./event_dedupe_store.py:/app/event_dedupe_store.py:ro
    networks:
      - matrix-internal
    depends_on:
      matrix-api:
        condition: service_started
      mcp-server:
        condition: service_started
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import sys; sys.exit(0)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  matrix-api:
    image: ghcr.io/oculairmedia/letta-matrix-api:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
    volumes:
      - ./matrix_client_data:/app/data
    ports:
      - 8004:8000
    networks:
      - matrix-internal
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix API"
      - "homepage.icon=si-api"
      - "homepage.href=http://192.168.50.90:8004"
      - "homepage.description=Matrix API server for automation"
  mcp-server:
    image: ghcr.io/oculairmedia/letta-matrix-mcp:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_API_URL=http://matrix-api:8000
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8005
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PORT=8006
    ports:
      - 8015:8005 # WebSocket port (host:container)
      - 8016:8006 # HTTP streaming port (host:container)
    networks:
      - matrix-internal
    depends_on:
      - matrix-api
    volumes:
      - ./mcp_data:/app/data
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Matrix MCP Server"
      - "homepage.icon=si-websocket"
      - "homepage.href=http://192.168.50.90:8016"
      - "homepage.description=Matrix MCP server for Claude integration"
  letta-agent-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.letta-agent-mcp
    image: letta-matrix-mcp:local
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_API_URL=http://matrix-api:8000
      - MATRIX_HOMESERVER_URL=http://tuwunel:6167
      - LETTA_API_URL=http://192.168.50.90:8289
      - LETTA_AGENT_MCP_HOST=0.0.0.0
      - LETTA_AGENT_MCP_PORT=8017
    ports:
      - 8017:8017
    networks:
      - matrix-internal
    depends_on:
      - matrix-api
      - matrix-client
    volumes:
      - ./matrix_client_data:/app/data
    labels:
      - "homepage.group=Communication"
      - "homepage.name=Letta Agent MCP"
      - "homepage.icon=si-chat"
      - "homepage.href=http://192.168.50.90:8017"
      - "homepage.description=Inter-agent communication MCP server"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8017/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
networks:
  matrix-internal:
    driver: bridge
