# Production Docker Compose - Uses pre-built images from GitHub Container Registry
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#
# Before using:
#   1. Login to GitHub Container Registry:
#      echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
#   2. Copy .env.example to .env and configure your settings
#   3. Pull latest images:
#      docker-compose -f docker-compose.prod.yml pull

version: '3.8'

services:
  synapse:
    image: docker.io/matrixdotorg/synapse:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SYNAPSE_DATABASE_HOST=${POSTGRES_HOST}
      - SYNAPSE_DATABASE_PORT=${POSTGRES_PORT}
      - SYNAPSE_DATABASE_USER=${POSTGRES_USER}
      - SYNAPSE_DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - SYNAPSE_DATABASE_NAME=${POSTGRES_DB}
    volumes:
      - ${SYNAPSE_DATA_PATH}:/data
      - ./synapse_entrypoint.sh:/synapse_entrypoint.sh:ro
    entrypoint: /synapse_entrypoint.sh
    depends_on:
      - db
    networks:
      - matrix-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/_matrix/client/versions"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  db:
    image: docker.io/postgres:15-alpine
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data
    networks:
      - matrix-internal

  element:
    image: vectorim/element-web:latest
    restart: unless-stopped
    volumes:
      - ${ELEMENT_CONFIG_PATH}:/app/config.json:ro
    networks:
      - matrix-internal

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - ${NGINX_HTTP_PORT}:80
    volumes:
      - ${NGINX_CONFIG_PATH}:/etc/nginx/conf.d/default.conf:ro
    networks:
      - matrix-internal
    depends_on:
      - synapse
      - element

  # Use pre-built image from GitHub Container Registry
  matrix-client:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-oculairmedia}/letta-matrix-client:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://synapse:8008
    volumes:
      - ./matrix_store:/app/matrix_store
      - ./matrix_client_data:/app/data
    networks:
      - matrix-internal
    depends_on:
      synapse:
        condition: service_healthy
      matrix-api:
        condition: service_started
      mcp-server:
        condition: service_started

  # Use pre-built image from GitHub Container Registry
  matrix-api:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-oculairmedia}/letta-matrix-api:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MATRIX_HOMESERVER_URL=http://synapse:8008
    ports:
      - "${MATRIX_API_PORT:-8004}:8000"
    networks:
      - matrix-internal
    depends_on:
      synapse:
        condition: service_healthy

  # Use pre-built image from GitHub Container Registry
  mcp-server:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-oculairmedia}/letta-matrix-mcp:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${MCP_WS_PORT:-8015}:8005"
      - "${MCP_HTTP_PORT:-8016}:8006"
    volumes:
      - ./mcp_data:/app/data
    networks:
      - matrix-internal

networks:
  matrix-internal:
    driver: bridge
