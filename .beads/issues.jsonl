{"id":"bd-0657b","title":"Epic: Conversations API Integration - Phase 1 Foundation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-17T15:31:19.972Z","updated_at":"2026-01-17T22:28:53.984096009-05:00","closed_at":"2026-01-17T22:28:53.984096009-05:00","close_reason":"Closed","labels":["huly:MXSYN-326"],"comments":[{"id":706,"issue_id":"bd-0657b","author":"vibesync","text":"Synced from Huly: MXSYN-326","created_at":"2026-01-17T15:31:19Z"}]}
{"id":"bd-3440c","title":"Add 409 CONVERSATION_BUSY retry logic with exponential backoff","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-17T17:02:48.255Z","updated_at":"2026-01-17T22:28:53.97730548-05:00","closed_at":"2026-01-17T22:28:53.97730548-05:00","close_reason":"Closed","labels":["huly:MXSYN-330"],"comments":[{"id":710,"issue_id":"bd-3440c","author":"vibesync","text":"## Overview\n\nLetta 0.16.2 returns HTTP 409 with `CONVERSATION_BUSY` when an agent is already processing a message. We need to handle this gracefully.\n\n## Requirements\n\n### Retry Strategy\n\n- Use exponential backoff: 1s, 2s, 4s, 8s (max 4 retries)\n- Log each retry attempt at INFO level\n- After max retries, queue message for later or notify user\n\n### Implementation\n\n1. Create `src/letta/retry.py` with:\n   - `is_conversation_busy(response)` - Check for 409 + CONVERSATION_BUSY\n   - `retry_with_backoff(func, max_retries=4)` - Async retry decorator\n2. Wrap Letta API calls in `send_message_to_agent()` with retry logic\n3. Track metrics:\n   - `letta_conversation_busy_total` counter\n   - `letta_retry_attempts_total` counter by attempt number\n\n### Error Response Format (from Letta)\n\n```json\n{\n  \"error\": \"CONVERSATION_BUSY\",\n  \"message\": \"Agent is currently processing another message\"\n}\n```\n\n## Acceptance Criteria\n\n- [ ] 409 responses trigger automatic retry\n- [ ] Exponential backoff between retries\n- [ ] Metrics track busy responses and retries\n- [ ] After max retries, graceful degradation (user notification)\n- [ ] Unit tests for retry logic\n\n## Part of Epic\n\nMXSYN-326: Conversations API Integration - Phase 1 Foundation\n\n---\nHuly Issue: MXSYN-330","created_at":"2026-01-17T17:02:48Z"}]}
{"id":"bd-530fb","title":"Implement shadow mode - fallback to legacy API on Conversations API failure","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-17T15:30:30.243Z","updated_at":"2026-01-17T22:28:38.048515357-05:00","labels":["huly:MXSYN-331"],"comments":[{"id":704,"issue_id":"bd-530fb","author":"vibesync","text":"## Overview\n\nDuring the transition to Letta 0.16.2 Conversations API, we need a safety net that falls back to the legacy `send_message()` API if the Conversations API fails unexpectedly.\n\n## Requirements\n\n### Configuration\n\nAdd to config:\n\n```yaml\nletta:\n  conversations_api:\n    enabled: true  # Master switch\n    shadow_mode: true  # Fallback on failure\n    shadow_mode_log_level: WARNING  # Log fallbacks\n```\n\n### Implementation\n\n1. In `send_message_to_agent()`:\n   - Try Conversations API first (if enabled)\n   - On non-409 error, log and fall back to legacy API (if shadow_mode=true)\n   - Track metrics for fallback events\n2. Metrics:\n   - `letta_conversations_api_fallback_total` counter\n   - `letta_api_mode` gauge (0=legacy, 1=conversations, 2=shadow)\n\n### Fallback Triggers\n\n- HTTP 500+ from Letta\n- Connection errors\n- Conversation creation failures\n- NOT triggered by 409 CONVERSATION_BUSY (that uses retry logic)\n\n## Acceptance Criteria\n\n- [ ] Shadow mode configurable via YAML\n- [ ] Automatic fallback on Conversations API failures\n- [ ] Metrics track fallback events\n- [ ] Fallback attempts logged at configured level\n- [ ] Legacy API still works when conversations disabled\n- [ ] Unit tests for fallback logic\n\n## Part of Epic\n\nMXSYN-326: Conversations API Integration - Phase 1 Foundation\n\n---\nHuly Issue: MXSYN-331","created_at":"2026-01-17T15:30:30Z"}]}
{"id":"bd-6cca5","title":"Create room_conversations DB schema + migration","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-17T15:31:19.706Z","updated_at":"2026-01-17T22:26:47.676122393-05:00","labels":["huly:MXSYN-327"],"comments":[{"id":705,"issue_id":"bd-6cca5","author":"vibesync","text":"Synced from Huly: MXSYN-327","created_at":"2026-01-17T15:31:19Z"}]}
{"id":"bd-9fedc","title":"Update message_callback to use Conversations API","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-17T15:31:20.595Z","updated_at":"2026-01-17T11:32:01.416013157-05:00","closed_at":"2026-01-17T11:32:01.4164255-05:00","labels":["huly:MXSYN-329"],"comments":[{"id":708,"issue_id":"bd-9fedc","author":"vibesync","text":"Synced from Huly: MXSYN-329","created_at":"2026-01-17T15:31:20Z"}]}
{"id":"bd-ad090","title":"Implement get_or_create_room_conversation()","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-17T15:31:20.909Z","updated_at":"2026-01-17T22:28:39.726612902-05:00","labels":["huly:MXSYN-328"],"comments":[{"id":709,"issue_id":"bd-ad090","author":"vibesync","text":"Synced from Huly: MXSYN-328","created_at":"2026-01-17T15:31:20Z"}]}
{"id":"bd-ecd0c","title":"Add integration tests for conversation isolation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-17T15:31:20.278Z","updated_at":"2026-01-17T22:28:53.98160086-05:00","closed_at":"2026-01-17T22:28:53.98160086-05:00","close_reason":"Closed","labels":["huly:MXSYN-332"],"comments":[{"id":707,"issue_id":"bd-ecd0c","author":"vibesync","text":"Synced from Huly: MXSYN-332","created_at":"2026-01-17T15:31:20Z"}]}
{"id":"matrix-synapse-deployment-02b","title":"Implement Docling API client for document conversion","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-02T06:43:52.233025211Z","updated_at":"2026-01-12T00:33:37.366772092-05:00","labels":["huly:MXSYN-218","huly:MXSYN-223","huly:MXSYN-229","huly:MXSYN-259"]}
{"id":"matrix-synapse-deployment-03ey","title":"Add OCR support for scanned PDFs and images","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-02T12:10:14.464430245Z","updated_at":"2026-01-11T19:50:25.128012289-05:00","closed_at":"2026-01-11T19:50:25.128016877-05:00","labels":["huly:MXSYN-216","huly:MXSYN-258"],"comments":[{"id":224,"issue_id":"matrix-synapse-deployment-03ey","author":"root","text":"## Objective\n\nEnable OCR extraction for scanned documents and images.\n\n## Implementation\n\n1. Detect if PDF is scanned (no selectable text)\n2. Enable OCR in Docling request for images (PNG, JPG)\n3. Handle mixed documents (some pages scanned, some not)\n\n## Supported Formats\n\n- Scanned PDFs\n- PNG images\n- JPG/JPEG images\n\n## Acceptance Criteria\n\n- [ ] OCR extracts text from scanned PDFs\n- [ ] Images converted to searchable Markdown\n- [ ] OCR accuracy \u003e 95% for clear scans\n- [ ] Processing time \u003c 30s for typical 10-page document\n\n---\nHuly Issue: MXSYN-11","created_at":"2026-01-02T12:10:14Z"}]}
{"id":"matrix-synapse-deployment-04a","title":"Extract service initialization for xmcp","description":"Move startup/service initialization from src/index.ts into reusable services module for xmcp middleware.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:04.388948481-05:00","updated_at":"2026-01-17T22:27:51.95244502-05:00","closed_at":"2026-01-17T22:27:51.95244502-05:00","close_reason":"Closed","labels":["huly:MXSYN-299"]}
{"id":"matrix-synapse-deployment-08w4","title":"Add support for DOCX and PPTX formats","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-02T17:59:12.783364326Z","updated_at":"2026-01-11T19:57:02.187092642-05:00","closed_at":"2026-01-11T19:57:02.187096519-05:00","labels":["huly:MXSYN-208","huly:MXSYN-253"],"comments":[{"id":446,"issue_id":"matrix-synapse-deployment-08w4","author":"root","text":"## Objective\n\nExtend document processing to support Microsoft Office formats.\n\n## Supported Formats\n\n- DOCX (Word documents)\n- PPTX (PowerPoint presentations)\n- TXT (plain text)\n- MD (Markdown passthrough)\n\n## Implementation\n\n1. Detect file type from mimetype/extension\n2. Send to Docling for conversion\n3. Handle multi-slide PPTX appropriately\n\n## Acceptance Criteria\n\n- [ ] DOCX converted to Markdown with formatting preserved\n- [ ] PPTX slides converted to structured Markdown\n- [ ] Plain text files handled correctly\n\n---\nHuly Issue: MXSYN-12","created_at":"2026-01-02T17:59:13Z"}]}
{"id":"matrix-synapse-deployment-0ac","title":"Implement Letta file upload with metadata","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:30.792089571Z","updated_at":"2026-01-11T19:57:04.334178941-05:00","closed_at":"2026-01-11T19:57:04.334183089-05:00","labels":["huly:MXSYN-266","huly:MXSYN-275"]}
{"id":"matrix-synapse-deployment-0h2r","title":"Clarify Docling API specifications","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-02T12:27:40.897871726Z","updated_at":"2026-01-11T19:57:01.840790642-05:00","closed_at":"2026-01-11T19:57:01.840793768-05:00","labels":["huly:MXSYN-214","huly:MXSYN-257"],"comments":[{"id":234,"issue_id":"matrix-synapse-deployment-0h2r","author":"root","text":"## Objective\n\nDocument the exact Docling REST API interface for integration.\n\n## Known Information ✅\n\n- **API URL**: http://192.168.50.90:3057\n- **Swagger Docs**: http://192.168.50.90:3057/docs\n- **Flower Monitoring**: http://192.168.50.90:3058\n- **Architecture**: Celery-based async processing (Redis + 2 workers)\n\n## Questions to Answer\n\n1. **Endpoint Path**: What is the conversion endpoint? (? ?)\n2. **Authentication**: API key? Bearer token? None?\n3. **Request Format**: Multipart form-data or base64 JSON?\n4. **Response Format**: Confirm Markdown output structure\n5. **Async Processing**: How to poll for job completion?\n6. **File Size Limits**: Maximum supported file size?\n\n## Deliverable\n\n- [ ] Test API with sample PDF via Swagger UI\n- [ ] Document request/response format\n- [ ] Create code example for integration\n\n---\nHuly Issue: MXSYN-2","created_at":"2026-01-02T12:27:41Z"}]}
{"id":"matrix-synapse-deployment-0sn","title":"Documentation and examples for file upload integration","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:33.655745143Z","updated_at":"2026-01-11T19:56:54.691268618-05:00","closed_at":"2026-01-11T19:56:54.691276904-05:00","labels":["huly:MXSYN-281","huly:MXSYN-285"],"comments":[{"id":13,"issue_id":"matrix-synapse-deployment-0sn","author":"node","text":"## Objective\n\nCreate comprehensive documentation for the file upload feature.\n\n## Documentation\n\n1. **User Guide**: How to use file upload feature\n2. **Admin Guide**: Configuration and deployment\n3. **API Reference**: Docling and Letta API usage\n4. **Troubleshooting**: Common issues and solutions\n\n## Examples\n\n- Sample Python client for testing\n- curl commands for API testing\n- Configuration templates\n\n## Location\n\n- BookStack: Letta Integration book\n- Project README\n\n## Acceptance Criteria\n\n- [ ] User-facing documentation complete\n- [ ] Admin deployment guide\n- [ ] Code examples working\n- [ ] Troubleshooting guide\n\n---\nHuly Issue: MXSYN-18","created_at":"2025-12-22T23:46:33Z"}]}
{"id":"matrix-synapse-deployment-0wi","title":"Deploy MCP Agent Mail server on port 8766","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T01:21:55.421766152Z","updated_at":"2026-01-11T19:56:59.705475454-05:00","closed_at":"2026-01-11T19:56:59.705483118-05:00","labels":["huly:MXSYN-147","huly:MXSYN-160"],"comments":[{"id":61,"issue_id":"matrix-synapse-deployment-0wi","author":"root","text":"Complete Docker build and deploy MCP Agent Mail as Layer 2 coordination system.\n\n## Tasks\n\n- Complete Docker compose build (already started)\n- Configure compose.yaml for port 8766\n- Start container and verify health\n- Configure .env for coordination mode (disable messaging features)\n- Test basic MCP HTTP endpoint\n\n## Success Criteria\n\n- Container running and healthy\n- Health endpoint responds: {\"detail\":\"Not Found\"}\n- Bearer token configured and working\n\n## Context\n\nMCP Agent Mail provides platform integrations and file reservations that Matrix doesn't handle. See docs/MCP_AGENT_MAIL_REEVALUATION.md\n\n---\nHuly Issue: MXSYN-51","created_at":"2026-01-02T01:21:55Z"}]}
{"id":"matrix-synapse-deployment-10d2","title":"Phase 2: Integrate Streaming into Matrix Client","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-02T21:48:39.425724265Z","updated_at":"2026-01-12T00:33:38.528644224-05:00","closed_at":"2026-01-12T00:33:38.528649784-05:00","labels":["huly:MXSYN-204","huly:MXSYN-245","huly:MXSYN-247"],"dependencies":[{"issue_id":"matrix-synapse-deployment-10d2","depends_on_id":"matrix-synapse-deployment-2lx","type":"parent-child","created_at":"2026-01-04T01:08:32.997662085Z","created_by":"unknown"}],"comments":[{"id":539,"issue_id":"matrix-synapse-deployment-10d2","author":"root","text":"Synced from Beads: matrix-synapse-deployment-9zx\n\n---\nHuly Issue: MXSYN-46","created_at":"2026-01-02T21:48:39Z"}]}
{"id":"matrix-synapse-deployment-12h","title":"Room ops module for xmcp","description":"Extract room_join/leave/info/list/create/invite/search operations into module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:35.266004301-05:00","updated_at":"2026-01-17T22:27:51.961279853-05:00","closed_at":"2026-01-17T22:27:51.961279853-05:00","close_reason":"Closed","labels":["huly:MXSYN-313","vibe:3aa213aa-dd74-47ea-839d-30c7ef5679e7"]}
{"id":"matrix-synapse-deployment-1a3","title":"Implement forward_to_agent_room() for inter-agent message routing","description":"## Summary\nCreate a function to forward/copy messages to another agent's room when @mentions are detected. Messages should appear in BOTH the source room AND the target agent's room for audit trail.\n\n## Location\n`src/matrix/client.py`\n\n## Function Signature\n```python\nasync def forward_to_agent_room(\n    source_room_id: str,\n    target_room_id: str,\n    message: str,\n    sender_mxid: str,\n    sender_agent_name: str,\n    target_agent_name: str,\n    original_event_id: str,\n    config: Config,\n    logger: logging.Logger\n) -\u003e Optional[str]:\n    \"\"\"\n    Forward a message to another agent's room as inter-agent communication.\n    \n    The original message stays in source_room_id.\n    A copy with attribution is sent to target_room_id.\n    \n    Args:\n        source_room_id: Room where message originated\n        target_room_id: Room to forward to (target agent's room)\n        message: The message content\n        sender_mxid: Matrix ID of the sender\n        sender_agent_name: Display name of sending agent\n        target_agent_name: Display name of target agent\n        original_event_id: Event ID of original message (for reference)\n        config: App config\n        logger: Logger instance\n        \n    Returns:\n        Event ID of forwarded message, or None on failure\n    \"\"\"\n```\n\n## Message Format in Target Room\nThe forwarded message should be clearly attributed:\n\n```\n[Forwarded from {sender_agent_name}]\n\n{original_message}\n\n---\nSource: {source_room_id}\nOriginal event: {original_event_id}\n```\n\nOr simpler:\n```\n[@{sender_agent_name} mentioned you]\n\n{original_message}\n```\n\n## Sending Identity\nThe forwarded message should be sent AS the sending agent (using their Matrix identity from the identity pool), NOT as a system user. This maintains proper attribution.\n\n```python\nfrom src.matrix.identity_client_pool import get_client_for_identity\n\n# Get the sender agent's Matrix client\nsender_mapping = get_mapping_by_matrix_user(sender_mxid)\nif sender_mapping:\n    client = await get_client_for_identity(sender_mxid, config, logger)\n    # Send message via this client to target room\n```\n\n## Loop Prevention\nMark forwarded messages to prevent re-forwarding:\n\n```python\nmessage_content = {\n    'msgtype': 'm.text',\n    'body': formatted_message,\n    'm.forwarded': True,  # Custom flag\n    'm.forward_source': {\n        'room_id': source_room_id,\n        'event_id': original_event_id,\n        'sender': sender_mxid\n    }\n}\n```\n\nThen in message_callback, skip forwarded messages:\n```python\nif content.get('m.forwarded'):\n    logger.debug('Skipping forwarded message to prevent loops')\n    return\n```\n\n## Error Handling\n- [ ] Target room doesn't exist → log error, skip\n- [ ] Sender not in target room → auto-join or log error\n- [ ] Rate limiting → implement backoff\n- [ ] Network errors → log and continue (don't block source room processing)\n\n## Audit Trail Benefits\n- Message appears in source room (original)\n- Message appears in target room (forwarded copy)\n- Both have clear attribution\n- Emmanuel can see full conversation flow in Element\n\n## Tests\n- [ ] Forward single mention\n- [ ] Forward multiple mentions (one message → multiple target rooms)\n- [ ] Forwarded message has correct attribution\n- [ ] Forwarded message marked with m.forwarded\n- [ ] Loop prevention works (forwarded messages not re-processed)\n\n## Dependencies\n- Depends on: matrix-synapse-deployment-uxj (extract_agent_mentions)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T18:39:32.141963766-05:00","updated_at":"2026-01-17T22:28:53.999290123-05:00","closed_at":"2026-01-17T22:28:53.999290123-05:00","close_reason":"Closed","labels":["feature","huly:MXSYN-322","mention-routing","vibe:a748ff08-a321-4735-9b10-88c8001d6ef5"]}
{"id":"matrix-synapse-deployment-1cd","title":"Implement retry logic for failed conversions","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:32.703293485Z","updated_at":"2025-12-22T23:46:32.703293485Z","labels":["huly:MXSYN-288","huly:MXSYN-291"],"comments":[{"id":7,"issue_id":"matrix-synapse-deployment-1cd","author":"node","text":"## Objective\n\nAdd robust error handling and retry logic for document processing.\n\n## Implementation\n\n1. Retry failed Docling requests (max 3 attempts)\n2. Exponential backoff between retries\n3. Queue failed jobs for later retry\n4. Alert on persistent failures\n\n## Error Scenarios\n\n- Docling service unavailable\n- Timeout on large documents\n- Corrupt/invalid file format\n- Rate limiting\n\n## Acceptance Criteria\n\n- [ ] Transient failures auto-retry\n- [ ] Persistent failures logged and alerted\n- [ ] User notified of final failure status\n- [ ] Failed jobs can be manually retried\n\n---\nHuly Issue: MXSYN-13","created_at":"2025-12-22T23:46:32Z"}]}
{"id":"matrix-synapse-deployment-1dr","title":"Testing: Streaming Unit and Integration Tests","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:31.545776647Z","updated_at":"2026-01-11T19:57:03.601028727-05:00","closed_at":"2026-01-11T19:57:03.601037363-05:00","labels":["huly:MXSYN-292","huly:MXSYN-295"],"dependencies":[{"issue_id":"matrix-synapse-deployment-1dr","depends_on_id":"matrix-synapse-deployment-2lx","type":"parent-child","created_at":"2026-01-04T01:08:32.691544884Z","created_by":"unknown"}],"comments":[{"id":2,"issue_id":"matrix-synapse-deployment-1dr","author":"node","text":"# Streaming Tests\n\n## Unit Tests\n\n### \n\n- [ ] Test  initialization\n- [ ] Test event parsing for each message type\n- [ ] Test error handling (timeout, connection error)\n- [ ] Test message normalization\n- [ ] Mock Letta SDK stream responses\n\n### Test Cases\n\n\n\n## Integration Tests\n\n### \n\n- [ ] Real streaming against test agent\n- [ ] Long-running operation with background mode\n- [ ] Connection recovery simulation\n- [ ] Multi-step tool chain streaming\n\n### Test Scenarios\n\n1. Simple prompt → Single assistant response\n2. Search prompt → tool_call → tool_return → assistant\n3. Complex prompt → Multiple tool calls → Multiple returns → assistant\n4. Error scenario → LLM error → Graceful failure\n5. Long operation → Background mode → Recovery\n\n## Manual Testing Checklist\n\n- [ ] Basic message in Matrix triggers streaming\n- [ ] Tool progress visible during execution\n- [ ] Final response correct\n- [ ] No duplicate messages\n- [ ] Error messages clear\n- [ ] Works with different agents\n- [ ] Fallback works when streaming disabled\n\n## Test Data\n\n- Simple agent without tools\n- Agent with conversation_search tool\n- Agent with multiple tools\n- Agent with long-running tools\n\n---\nHuly Issue: MXSYN-25","created_at":"2025-12-22T23:46:31Z"}]}
{"id":"matrix-synapse-deployment-1td","title":"OpenCode Room Persistence: Bridge lookup room on registration","description":"Update opencode-bridge to lookup existing room when an OpenCode instance registers.\n\n**Current Flow:**\n1. Plugin registers with bridge\n2. Bridge creates registration with `rooms: []`\n3. Room not associated until `talk_to_opencode` called\n\n**New Flow:**\n1. Plugin registers with bridge\n2. Bridge calls `GET /opencode/{directory}/room` API\n3. If room exists, add to registration.rooms and roomToRegistration map\n4. Messages forward immediately\n\n**File:** `opencode-bridge/src/index.ts`\n\n**Changes:**\n- Add API call in /register handler\n- Populate roomToRegistration map on registration (not just on WS auth)\n\n**Depends on:** matrix-synapse-deployment-vyw (API endpoints)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-23T00:04:29.614577723-05:00","created_by":"root","updated_at":"2026-01-23T00:12:25.917884834-05:00","closed_at":"2026-01-23T00:12:25.917884834-05:00","close_reason":"Superseded by simpler disk-based approach: matrix-synapse-deployment-ele","labels":["huly:MXSYN-334","vibe:108ed155-1b00-4172-b740-23d3c5a961dd"]}
{"id":"matrix-synapse-deployment-1tus","title":"Implement Matrix notification for processing status","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-03T02:37:41.678917197Z","updated_at":"2026-01-11T19:57:03.983204474-05:00","closed_at":"2026-01-11T19:57:03.983209855-05:00","labels":["huly:MXSYN-203","huly:MXSYN-244"],"comments":[{"id":628,"issue_id":"matrix-synapse-deployment-1tus","author":"root","text":"Synced from Beads: matrix-synapse-deployment-5e5\n\n---\nHuly Issue: MXSYN-89","created_at":"2026-01-03T02:37:42Z"}]}
{"id":"matrix-synapse-deployment-1yc","title":"OpenCode plugin wiring","description":"OpenCode plugin that wires Matrix client to session context injection.\n\n## Summary\nThe main plugin file that loads on OpenCode start, spawns the Matrix client, and injects inbound messages into the active session context.\n\n## Requirements\n- Plugin loads from `.opencode/plugin/matrix-context-injector.ts`\n- Reads config from `.opencode/matrix.yaml`\n- Spawns Matrix client on plugin load\n- Injects messages using same mechanism as `p2p-bridge.ts` (`client.session.prompt` with `noReply: true`)\n- Per-folder lockfile: if lock exists and held, refuse to start with clear error\n- Dedupe cache: track `event_id` with TTL to prevent re-injection on reconnect\n- Clean shutdown: stop Matrix client on process exit\n\n## Injection Format\n```\n[Matrix from {displayName} in {roomAlias}]\n{body}\n```\n\n## Acceptance Criteria\n- [ ] Messages from Matrix appear in OpenCode session context\n- [ ] No duplicate injections (dedupe works across reconnects)\n- [ ] Per-folder lock prevents dual-session conflicts\n- [ ] Clean shutdown (no orphan processes/connections)\n- [ ] Clear errors for missing config / auth failures\n\n## Dependencies\n- matrix-synapse-deployment-chq (spec)\n- matrix-synapse-deployment-8r3 (Matrix client module)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T13:37:40.39756747-05:00","updated_at":"2026-01-14T14:25:23.487894666-05:00","closed_at":"2026-01-14T14:25:23.487894666-05:00","close_reason":"implemented","labels":["huly:MXSYN-294","vibe:1cf30d54-60e4-4532-9015-d41ce618428c"]}
{"id":"matrix-synapse-deployment-21s","title":"Add agent name resolution by display name to mapping_service","description":"## Summary\nAdd a function to resolve agents by their friendly display name (e.g., 'Meridian', 'BMO') in addition to agent_id and matrix_user_id.\n\n## Why Needed\nFor @mention routing, users and agents will mention other agents by name like `@Meridian` rather than the full MXID `@agent_597b5756_2915_4560_ba6b_91005f085166:matrix.oculair.ca`.\n\n## Implementation\n\n### New Function in `src/core/mapping_service.py`\n```python\ndef get_mapping_by_agent_name(agent_name: str, fuzzy: bool = True) -\u003e Optional[dict]:\n    \"\"\"\n    Get mapping for an agent by display name.\n    \n    Args:\n        agent_name: The agent's display name (e.g., 'Meridian', 'BMO')\n        fuzzy: If True, do case-insensitive partial matching\n        \n    Returns:\n        Mapping dict or None if not found\n    \"\"\"\n```\n\n### Matching Strategy\n1. Exact match (case-insensitive)\n2. Partial match - agent_name contains search term\n3. Handle 'Huly - ' prefix (e.g., 'Matrix Synapse Deployment' matches 'Huly - Matrix Synapse Deployment')\n\n### Database Query\nAdd method to `AgentMappingDB` class:\n```python\ndef get_by_agent_name(self, name: str, fuzzy: bool = True) -\u003e Optional[AgentMapping]:\n    # Case-insensitive search\n    # Return best match if fuzzy\n```\n\n## Tests\n- [ ] Exact name match: 'Meridian' → agent-597b5756...\n- [ ] Case insensitive: 'meridian' → agent-597b5756...\n- [ ] Huly prefix stripping: 'Matrix Synapse Deployment' → Huly - Matrix Synapse Deployment\n- [ ] No match returns None\n- [ ] Multiple partial matches returns best/first match\n\n## Dependencies\n- None (standalone enhancement)\n\n## Blocked By\n- None","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T18:38:27.807601806-05:00","updated_at":"2026-01-17T22:28:54.01451216-05:00","closed_at":"2026-01-17T22:28:54.01451216-05:00","close_reason":"Closed","labels":["feature","huly:MXSYN-317","mapping-service"]}
{"id":"matrix-synapse-deployment-231j","title":"Add unit tests for external source audit posting","description":"## Context\nWhen a webhook arrives for an agent with no tracked Matrix conversation (CLI/API call), the handler should post an audit message.\n\n## Requirements\n- Test that handleRunCompleted() posts audit when no conversation is tracked (source: external)\n- Test that audit message format is correct (emoji, truncation, etc.)\n- Mock Matrix client to verify postSilentAudit is called\n\n## Files\n- mcp-servers/matrix-identity-bridge/src/core/letta-webhook-handler.ts\n- mcp-servers/matrix-identity-bridge/tests/webhook-audit-skip.test.ts","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T20:43:03.57044743-05:00","updated_at":"2026-01-17T22:29:14.13419995-05:00","closed_at":"2026-01-17T22:29:14.13419995-05:00","close_reason":"Closed","labels":["huly:MXSYN-138","test"]}
{"id":"matrix-synapse-deployment-2bu","title":"Rename matrix-client container to letta-matrix-bridge","description":"## Summary\nThe current container name 'matrix-client' is generic and doesn't reflect its actual purpose as the dedicated Letta-Matrix integration bridge.\n\n## Current State\n- Container: `matrix-synapse-deployment-matrix-client-1`\n- Image: `ghcr.io/oculairmedia/letta-matrix-client:latest`\n- Purpose: Handles all Letta ↔ Matrix message routing, agent sync, streaming responses\n\n## Proposed Change\nRename to `letta-matrix-bridge` to accurately reflect:\n- It bridges Letta agents to Matrix rooms\n- It handles inter-agent communication\n- It syncs agent memory blocks\n- It manages agent-to-room mappings\n\n## Tasks\n- [ ] Update docker-compose.yml service name\n- [ ] Update container_name if specified\n- [ ] Update GHCR image name in CI workflow\n- [ ] Update any references in other services (env vars, URLs)\n- [ ] Update documentation/README\n- [ ] Verify healthcheck still works after rename\n\n## Impact\n- Low risk - cosmetic change\n- May need to update monitoring/logging references","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T18:38:02.3875348-05:00","updated_at":"2026-01-16T18:38:02.3875348-05:00","labels":["devops","huly:MXSYN-318","refactor","vibe:a6a5c196-ffdb-4559-9607-17f426c44380"]}
{"id":"matrix-synapse-deployment-2cy","title":"Refactor client.py: Extract LettaCode module","description":"client.py is 2078 lines with multiple concerns. Extract these modules:\n\n1. **LettaCode API** (~243 lines) - src/letta/code_api.py\n   - handle_letta_code_command()\n   - call_letta_code_api()\n   - run_letta_code_task()\n   - LettaCodeApiError class\n   - State management functions\n\n2. **Agent Operations** (~155 lines) - src/matrix/agent_ops.py\n   - delete_message_as_agent()\n   - set_typing_as_agent()\n   - send_as_agent()\n   - send_as_agent_with_event_id()\n\n3. **Callbacks** (~415 lines) - src/matrix/callbacks.py\n   - message_callback()\n   - file_callback()\n\n4. **Room Utilities** (~88 lines) - src/matrix/room_utils.py\n   - create_room_if_needed()\n   - join_room_if_needed()\n\nThis would reduce client.py to ~1200 lines of core message routing logic.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-28T13:11:29.195268835-05:00","updated_at":"2025-12-28T13:11:43.954316671-05:00","labels":["huly:MXSYN-193","huly:MXSYN-234"]}
{"id":"matrix-synapse-deployment-2hpw","title":"Phase 3: Refactor ResponseMonitor for webhook-first","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T16:32:53.375873113Z","updated_at":"2026-01-02T16:32:53.375873113Z","labels":["huly:MXSYN-161","huly:MXSYN-211"],"dependencies":[{"issue_id":"matrix-synapse-deployment-2hpw","depends_on_id":"matrix-synapse-deployment-lg0a","type":"parent-child","created_at":"2026-01-02T16:32:53.715103514Z","created_by":"unknown"}],"comments":[{"id":364,"issue_id":"matrix-synapse-deployment-2hpw","author":"root","text":"1. Keep polling as fallback for agents without webhooks\n2. Add webhookEnabled flag to conversation tracking\n3. When webhook received, cancel any active polling\n4. Eventually deprecate polling entirely\n\n---\nHuly Issue: MXSYN-95","created_at":"2026-01-02T16:32:53Z"}]}
{"id":"matrix-synapse-deployment-2lx","title":"Implement Letta Streaming for Matrix Client","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:31.451589806Z","updated_at":"2026-01-11T19:57:03.255293673-05:00","closed_at":"2026-01-11T19:57:03.255296659-05:00","labels":["huly:MXSYN-294","huly:MXSYN-296"]}
{"id":"matrix-synapse-deployment-2rz","title":"OpenCode Room Persistence: Update MCP to use API instead of JSON","description":"Update `mcp-servers/matrix-identity-bridge/src/core/opencode-rooms.ts` to use the matrix-api database instead of local JSON file.\n\n**Changes:**\n1. Create `OpenCodeRoomClient` class (similar to `AgentMappingClient`)\n2. Replace `loadOpenCodeRoomMappings()` with API calls\n3. Replace `saveOpenCodeRoomMappings()` with API calls\n4. Update `getOrCreateOpenCodeRoom()` to use API\n5. Remove JSON file operations\n\n**Depends on:** matrix-synapse-deployment-vyw (API endpoints)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-23T00:04:12.683512166-05:00","created_by":"root","updated_at":"2026-01-23T00:12:25.91399116-05:00","closed_at":"2026-01-23T00:12:25.91399116-05:00","close_reason":"Superseded by simpler disk-based approach: matrix-synapse-deployment-ele","labels":["huly:MXSYN-335","vibe:9487afc4-1b6d-42e6-83f5-bb15a0023e19"]}
{"id":"matrix-synapse-deployment-385","title":"Validate OpenCode bridge behavior","description":"Confirm opencode_status/notify still use bridge endpoints.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:26.869353932-05:00","updated_at":"2026-01-17T22:28:54.012084368-05:00","closed_at":"2026-01-17T22:28:54.012084368-05:00","close_reason":"Closed","labels":["huly:MXSYN-304","vibe:884b744f-45c1-461b-a0ee-9ba621a106ce"]}
{"id":"matrix-synapse-deployment-3bj","title":"Add processing progress updates in Matrix","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:25.571581913Z","updated_at":"2026-01-03T11:10:03.447798373-05:00","closed_at":"2026-01-03T11:10:03.447798373-05:00","close_reason":"Duplicate of matrix-synapse-deployment-0wa2","labels":["huly:MXSYN-269","huly:MXSYN-271","huly:MXSYN-279"],"comments":[{"id":17,"issue_id":"matrix-synapse-deployment-3bj","author":"node","text":"## Objective\n\nProvide real-time progress updates for large document processing.\n\n## Implementation\n\n1. Send \"Processing started\" message immediately\n2. Update with progress for multi-page documents\n3. Send completion message with stats\n\n## Message Flow\n\n\n\n## Acceptance Criteria\n\n- [ ] Immediate acknowledgment of upload\n- [ ] Progress updates for large files (\u003e10 pages)\n- [ ] Final status with processing stats\n\n---\nHuly Issue: MXSYN-14","created_at":"2025-12-23T03:23:25Z"}]}
{"id":"matrix-synapse-deployment-3g1","title":"Reconcile Matrix user ID formats between matrix-client and identity-bridge","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T08:54:55.173180692Z","updated_at":"2025-12-28T08:54:55.173180692Z","labels":["huly:MXSYN-167","huly:MXSYN-219"]}
{"id":"matrix-synapse-deployment-3ow","title":"Implement Matrix notification for processing status","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:30.231888535Z","updated_at":"2026-01-03T11:10:03.03402729-05:00","closed_at":"2026-01-03T11:10:03.03402729-05:00","close_reason":"Duplicate of matrix-synapse-deployment-1tus","labels":["huly:MXSYN-267","huly:MXSYN-276"],"dependencies":[{"issue_id":"matrix-synapse-deployment-3ow","depends_on_id":"matrix-synapse-deployment-1tus","type":"related","created_at":"2026-01-03T11:10:03.036457195-05:00","created_by":"root"}],"comments":[{"id":20,"issue_id":"matrix-synapse-deployment-3ow","author":"node","text":"## Objective\n\nNotify users in Matrix when file processing completes or fails.\n\n## Implementation\n\n1. Send success message: \n2. Send error message: \n3. Optional: Send progress updates for large files\n\n## Message Format\n\n\n\n## Error Format\n\n\n\n## Acceptance Criteria\n\n- [ ] Success notification sent to room\n- [ ] Error notification with helpful message\n- [ ] Messages formatted cleanly\n\n---\nHuly Issue: MXSYN-9","created_at":"2025-12-23T03:23:30Z"}]}
{"id":"matrix-synapse-deployment-3sf","title":"Add user configuration options for file processing","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-26T18:43:34.909909262Z","updated_at":"2025-12-26T18:43:34.909909262Z","labels":["huly:MXSYN-244","huly:MXSYN-246","huly:MXSYN-261"],"comments":[{"id":39,"issue_id":"matrix-synapse-deployment-3sf","author":"node","text":"## Objective\n\nAllow users to configure file processing preferences.\n\n## Configuration Options\n\n1. **Auto-process**: Enable/disable automatic processing (opt-in)\n2. **Notifications**: Always / Errors only / Never\n3. **File types**: Which types to process\n4. **Privacy**: Mark files as \"do not index\"\n\n## Implementation\n\n- Room-level settings via Matrix state events\n- User preferences via bot commands\n- Default configuration in environment\n\n## Commands\n\n\n\n## Acceptance Criteria\n\n- [ ] Room-level configuration works\n- [ ] User preferences respected\n- [ ] Defaults are sensible (opt-in recommended)\n\n---\nHuly Issue: MXSYN-17","created_at":"2025-12-26T18:43:35Z"}]}
{"id":"matrix-synapse-deployment-41k","title":"Add request context injection for X-Agent-Id","description":"Ensure X-Agent-Id propagation into tool execution context in xmcp.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:09.525020055-05:00","updated_at":"2026-01-17T22:27:51.954657493-05:00","closed_at":"2026-01-17T22:27:51.954657493-05:00","close_reason":"Closed","labels":["huly:MXSYN-298","vibe:7dd27926-9a1e-46a8-8781-9fcdf3be9d0b"]}
{"id":"matrix-synapse-deployment-44n","title":"OpenCode Room Persistence: Add opencode_rooms table to matrix-api DB","description":"Add database table to store OpenCode room mappings persistently.\n\n**Schema:**\n```sql\nCREATE TABLE opencode_rooms (\n  directory TEXT PRIMARY KEY,\n  room_id TEXT NOT NULL,\n  identity_id TEXT NOT NULL,\n  identity_mxid TEXT NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n**Why:** Currently room mappings are in a JSON file. When services restart, the mapping is lost and messages don't forward until talk_to_opencode is called again.\n\n**Acceptance Criteria:**\n- Table exists in matrix-api database\n- Migration script created\n- Backward compatible with existing data","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-23T00:03:39.080356331-05:00","created_by":"root","updated_at":"2026-01-23T00:12:25.900394617-05:00","closed_at":"2026-01-23T00:12:25.900394617-05:00","close_reason":"Superseded by simpler disk-based approach: matrix-synapse-deployment-ele","labels":["huly:MXSYN-337","vibe:5d01d10c-cf48-4d11-acc9-3a92ce7d5236"]}
{"id":"matrix-synapse-deployment-48r","title":"[BLOCKER] Expose Docling API port in docker-compose","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:33.464412291Z","updated_at":"2026-01-03T11:10:03.714929406-05:00","closed_at":"2026-01-03T11:10:03.714929406-05:00","close_reason":"Duplicate of matrix-synapse-deployment-057m","labels":["huly:MXSYN-286","huly:MXSYN-289"],"comments":[{"id":12,"issue_id":"matrix-synapse-deployment-48r","author":"node","text":"## Problem - RESOLVED ✅\n\nThe Docling container is now running with exposed ports.\n\n## Current Status\n\n- **API**: http://192.168.50.90:3057/docs (Swagger UI)\n- **Flower Monitoring**: http://192.168.50.90:3058\n- **Services**: 5 containers (API, Redis, 2 workers, Flower)\n- **Stack**: \n\n## Next Steps\n\n- [ ] Test API endpoint with sample PDF\n- [ ] Document authentication method (if any)\n- [ ] Verify Markdown output format\n\n## Related\n\n- MXSYN-2: Clarify Docling API specifications\n\n---\nHuly Issue: MXSYN-1","created_at":"2025-12-22T23:46:33Z"}]}
{"id":"matrix-synapse-deployment-4esm","title":"Implement Letta folder management for Matrix rooms","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-03T03:42:17.932144524Z","updated_at":"2026-01-11T19:57:04.679657898-05:00","closed_at":"2026-01-11T19:57:04.679662226-05:00","labels":["huly:MXSYN-202","huly:MXSYN-243"],"comments":[{"id":667,"issue_id":"matrix-synapse-deployment-4esm","author":"root","text":"Synced from Beads: matrix-synapse-deployment-hjn\n\n---\nHuly Issue: MXSYN-40","created_at":"2026-01-03T03:42:18Z"}]}
{"id":"matrix-synapse-deployment-4hj","title":"Add environment configuration for file upload integration","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:33.599676036Z","updated_at":"2025-12-22T23:46:33.599676036Z","labels":["huly:MXSYN-282","huly:MXSYN-284","huly:MXSYN-287"]}
{"id":"matrix-synapse-deployment-4lp","title":"Create Matrix notification helpers for file reservations","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-26T18:45:11.005484264Z","updated_at":"2025-12-26T18:45:11.005484264Z","labels":["huly:MXSYN-195","huly:MXSYN-237"]}
{"id":"matrix-synapse-deployment-4lpt","title":"Implement Matrix file upload event detection","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-02T20:20:06.999524385Z","updated_at":"2026-01-12T00:33:38.18709235-05:00","closed_at":"2026-01-12T00:33:38.187096848-05:00","labels":["huly:MXSYN-206","huly:MXSYN-249","huly:MXSYN-251"],"comments":[{"id":502,"issue_id":"matrix-synapse-deployment-4lpt","author":"root","text":"Synced from Beads: matrix-synapse-deployment-uoo\n\n---\nHuly Issue: MXSYN-38","created_at":"2026-01-02T20:20:07Z"}]}
{"id":"matrix-synapse-deployment-4u8","title":"Test end-to-end multi-agent file coordination","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T18:45:11.664643447Z","updated_at":"2026-01-17T22:29:14.165169402-05:00","closed_at":"2026-01-17T22:29:14.165169402-05:00","close_reason":"Closed","labels":["huly:MXSYN-155","huly:MXSYN-183"],"comments":[{"id":43,"issue_id":"matrix-synapse-deployment-4u8","author":"node","text":"Comprehensive testing of the three-layer architecture with real agent workflows.\n\n## Test Scenarios\n\n1. **Scenario 1: Successful Reservation**\n   - OpenCode agent reserves \n   - Letta agent checks for conflicts → sees reservation\n   - Letta agent picks different file\n   - Both complete work without conflicts\n2. **Scenario 2: Pre-commit Guard**\n   - Agent A reserves file\n   - Agent B tries to commit changes to same file\n   - Pre-commit guard blocks commit\n   - Agent B sees clear error message\n3. **Scenario 3: Matrix Notifications**\n   - Agent reserves files\n   - Reservation appears in Matrix room\n   - Human sees notification in Element\n   - Agent releases → release notification appears\n4. **Scenario 4: Huly Integration**\n   - Agent reserves files with reason=MXSYN-XXX\n   - Reservation linked to Huly issue\n   - Audit trail shows issue context\n\n## Success Criteria\n\n- All scenarios pass\n- Zero file conflicts\n- Clear visibility in Matrix\n- Pre-commit guards work correctly\n\n## Parent\n\nBlocked by: Document MCP Agent Mail integration\n\n---\nHuly Issue: MXSYN-56","created_at":"2025-12-26T18:45:11Z"}]}
{"id":"matrix-synapse-deployment-4xn","title":"Add monitoring and alerting for file processing","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-26T18:43:45.052948157Z","updated_at":"2025-12-26T18:43:45.052948157Z","labels":["huly:MXSYN-236","huly:MXSYN-240","huly:MXSYN-260"],"comments":[{"id":40,"issue_id":"matrix-synapse-deployment-4xn","author":"node","text":"## Objective\n\nImplement observability for the file processing pipeline.\n\n## Metrics to Track\n\n- Files processed (daily/weekly)\n- Processing time distribution\n- Error rate by file type\n- Queue depth (pending files)\n- Docling worker health\n\n## Monitoring Stack\n\n- Flower UI for Celery monitoring (http://192.168.50.90:3058)\n- Custom metrics endpoint\n- Alert on high error rate or queue backup\n\n## Acceptance Criteria\n\n- [ ] Dashboard showing key metrics\n- [ ] Alerts for failures \u003e 5%\n- [ ] Alerts for queue \u003e 10 items\n- [ ] Historical data retention\n\n---\nHuly Issue: MXSYN-16","created_at":"2025-12-26T18:43:45Z"}]}
{"id":"matrix-synapse-deployment-4y6","title":"Performance optimization for document processing","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:33.92327493Z","updated_at":"2026-01-12T00:33:35.420889915-05:00","labels":["huly:MXSYN-273","huly:MXSYN-277","huly:MXSYN-280","huly:MXSYN-283"],"comments":[{"id":16,"issue_id":"matrix-synapse-deployment-4y6","author":"node","text":"## Objective\n\nOptimize processing pipeline for speed and resource efficiency.\n\n## Optimizations\n\n1. Parallel processing for multiple uploads\n2. Caching for repeated document uploads\n3. Optimize Docling worker configuration\n4. Stream large files instead of loading to memory\n\n## Targets\n\n- Processing time \u003c 30s for 10-page PDF\n- Support 5+ concurrent conversions\n- Memory usage \u003c 500MB per conversion\n\n## Acceptance Criteria\n\n- [ ] Benchmark current performance\n- [ ] Implement optimizations\n- [ ] Verify targets met\n- [ ] Document configuration tuning\n\n---\nHuly Issue: MXSYN-15","created_at":"2025-12-22T23:46:33Z"}]}
{"id":"matrix-synapse-deployment-55s","title":"Create script to provision rooms for all agents on-demand","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T08:53:22.586055518Z","updated_at":"2026-01-11T19:56:52.579855976-05:00","closed_at":"2026-01-11T19:56:52.579862529-05:00","labels":["huly:MXSYN-168","huly:MXSYN-220"]}
{"id":"matrix-synapse-deployment-5lo","title":"Add periodic health check for agent room provisioning","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T08:52:33.57782466Z","updated_at":"2025-12-28T08:52:33.57782466Z","labels":["huly:MXSYN-169","huly:MXSYN-221"]}
{"id":"matrix-synapse-deployment-5rx","title":"Phase 4: Investigate Token Streaming (Deferred)","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-22T23:46:31.885102366Z","updated_at":"2026-01-11T19:49:44.938038222-05:00","labels":["huly:MXSYN-290","huly:MXSYN-293"],"dependencies":[{"issue_id":"matrix-synapse-deployment-5rx","depends_on_id":"matrix-synapse-deployment-2lx","type":"parent-child","created_at":"2026-01-04T01:08:31.13906777Z","created_by":"unknown"}],"comments":[{"id":3,"issue_id":"matrix-synapse-deployment-5rx","author":"node","text":"# Token Streaming Investigation\n\n## Status: DEFERRED\n\nToken streaming () is currently not returning content chunks from the Letta server.\n\n## Current Behavior\n\nWhen :\n\n- Only  and  events received\n- No  or  chunks\n- Same behavior on direct API (port 8283) and proxy (port 8289)\n\n## Expected Behavior (per Letta docs)\n\nShould receive multiple chunks with same message ID:\n\n\n\n## Investigation Tasks\n\n- [ ] Test with different agents/models (GPT-4o, Gemini)\n- [ ] Check Letta server version\n- [ ] Review server logs for errors\n- [ ] Test on Letta Cloud vs self-hosted\n- [ ] Check if Claude Sonnet 4 supports token streaming via Letta\n\n## Potential Causes\n\n1. **Model limitation**: Claude Sonnet 4 may not support token streaming through Letta\n2. **Server configuration**: Token streaming may need to be enabled\n3. **Agent configuration**: May need specific agent settings\n4. **SDK version**: May need SDK update\n\n## Impact if Not Fixed\n\n- Step streaming provides adequate UX for most use cases\n- Token streaming mainly improves perceived latency\n- Not blocking for MVP\n\n## References\n\n- Letta docs: https://docs.letta.com/guides/agents/streaming/\n- Test script: \n\n---\nHuly Issue: MXSYN-24","created_at":"2025-12-22T23:46:31Z"}]}
{"id":"matrix-synapse-deployment-5tq","title":"Integrate MCP Agent Mail with OpenCode CLI","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T18:45:14.902110108Z","updated_at":"2026-01-17T22:29:14.162458652-05:00","closed_at":"2026-01-17T22:29:14.162458652-05:00","close_reason":"Closed","labels":["huly:MXSYN-154","huly:MXSYN-177","huly:MXSYN-178","huly:MXSYN-181"],"comments":[{"id":46,"issue_id":"matrix-synapse-deployment-5tq","author":"node","text":"Configure OpenCode to use MCP Agent Mail for file coordination and async messaging.\n\n## Tasks\n\n- Run integration script: \n- Update opencode.json with MCP server config\n- Add bearer token authentication\n- Test file reservation tools from OpenCode\n- Document agent workflow\n\n## Tools Available After Integration\n\n-  - Reserve files before editing\n-  - Async coordination messages\n-  - Check for FYI messages\n-  - See what other agents are doing\n\n## Success Criteria\n\n- OpenCode can call MCP Agent Mail tools\n- File reservations prevent conflicts\n- Agent workflow documented\n\n## Parent\n\nBlocked by: Install pre-commit guards\n\n---\nHuly Issue: MXSYN-53","created_at":"2025-12-26T18:45:15Z"}]}
{"id":"matrix-synapse-deployment-5wcc","title":"Implement: REST API Endpoints for Identity Operations","description":"## Task\nAdd FastAPI endpoints for identity CRUD operations and identity-based messaging.\n\n## Endpoints\n- POST/GET/PUT/DELETE /api/v1/identities - CRUD\n- GET /api/v1/identities/by-mxid/{mxid} - Lookup by Matrix ID\n- GET /api/v1/identities/by-agent/{agent_id} - Lookup by Letta agent\n- POST /api/v1/messages/send-as-identity - Send message as identity\n- POST /api/v1/dm-rooms - Create or get DM room\n\n## Deliverables\n- [ ] Extend src/api/app.py with new routes\n- [ ] Pydantic models in src/api/schemas/identity.py\n- [ ] OpenAPI documentation\n- [ ] Integration tests for all endpoints\n\n## Dependencies\n- Identity Manager\n- Identity Storage Service\n- Matrix Client Pool","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T11:04:55.026967947-05:00","updated_at":"2026-01-17T22:29:14.12781469-05:00","closed_at":"2026-01-17T22:29:14.12781469-05:00","close_reason":"Closed","labels":["api","huly:MXSYN-131","implementation"],"dependencies":[{"issue_id":"matrix-synapse-deployment-5wcc","depends_on_id":"matrix-synapse-deployment-b9mm","type":"blocks","created_at":"2026-01-03T11:06:28.410091029-05:00","created_by":"root"},{"issue_id":"matrix-synapse-deployment-5wcc","depends_on_id":"matrix-synapse-deployment-c9me","type":"blocks","created_at":"2026-01-03T11:06:33.57749305-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-5xi","title":"OpenCode Room Persistence: Integration tests","description":"Add integration tests to verify room mapping persistence across restarts.\n\n**Test Scenarios:**\n1. Create room via talk_to_opencode → restart bridge → verify messages still forward\n2. Create room via talk_to_opencode → restart MCP → verify room lookup works\n3. Create room via talk_to_opencode → restart OpenCode → verify immediate forwarding\n4. Cross-instance: Agent A sends to OpenCode B → message arrives\n\n**Test Location:** TBD (possibly `tests/integration/opencode-rooms.test.ts`)\n\n**Depends on:** All other persistence issues","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-23T00:04:46.125525221-05:00","created_by":"root","updated_at":"2026-01-23T00:04:46.125525221-05:00","labels":["huly:MXSYN-338","vibe:d5b8bf31-44b1-44df-ae17-5d758c7a831a"]}
{"id":"matrix-synapse-deployment-6hdy","title":"Add unit tests for matrix-direct audit skip logic","description":"## Context\nThe webhook handler now skips audit messages for matrix-direct conversations (fix in commit 75a6e06).\n\n## Requirements\n- Test that handleRunCompleted() returns matrix_direct_skip when conversation tracker has an active conversation\n- Test that source is correctly identified as 'matrix-direct' vs 'external'\n- Mock the conversation tracker to simulate both scenarios\n\n## Files\n- mcp-servers/matrix-identity-bridge/src/core/letta-webhook-handler.ts\n- mcp-servers/matrix-identity-bridge/tests/webhook-audit-skip.test.ts (new)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T20:43:01.753520801-05:00","updated_at":"2026-01-17T22:29:14.136634224-05:00","closed_at":"2026-01-17T22:29:14.136634224-05:00","close_reason":"Closed","labels":["huly:MXSYN-139","test"]}
{"id":"matrix-synapse-deployment-6p6","title":"Identity ops module for xmcp","description":"Extract identity_create/get/list/derive operations into module.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:40.403892015-05:00","updated_at":"2026-01-17T22:28:35.608718388-05:00","labels":["huly:MXSYN-312","vibe:7e8fa155-12d4-45e3-b3c6-376c18ee4371"]}
{"id":"matrix-synapse-deployment-6q8","title":"Phase 3: Long-Running Operation Support","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-23T03:28:05.100019191Z","updated_at":"2026-01-12T00:33:36.789279626-05:00","labels":["huly:MXSYN-248","huly:MXSYN-250","huly:MXSYN-255","huly:MXSYN-262","huly:MXSYN-263"],"dependencies":[{"issue_id":"matrix-synapse-deployment-6q8","depends_on_id":"matrix-synapse-deployment-2lx","type":"parent-child","created_at":"2026-01-04T01:08:30.780824266Z","created_by":"unknown"}],"comments":[{"id":33,"issue_id":"matrix-synapse-deployment-6q8","author":"node","text":"Synced from Beads: matrix-synapse-deployment-nqw\n\n---\nHuly Issue: MXSYN-43","created_at":"2025-12-23T03:28:05Z"}]}
{"id":"matrix-synapse-deployment-7hq","title":"Integrate MCP Agent Mail with Letta Code","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T18:45:13.331005485Z","updated_at":"2025-12-26T18:45:13.331005485Z","labels":["huly:MXSYN-180","huly:MXSYN-225"],"comments":[{"id":45,"issue_id":"matrix-synapse-deployment-7hq","author":"node","text":"Configure Letta Code to use MCP Agent Mail for coordination (note: using Letta Code, not Claude Code).\n\n## Tasks\n\n- Check if Letta Code has MCP integration capabilities\n- If yes: run integration script or manual config\n- If no: use Letta tools from previous issue instead\n- Test file coordination workflow\n- Document Letta Code + MCP Agent Mail setup\n\n## Research Needed\n\n- Does Letta Code support MCP servers?\n- What's the config file location?\n- Is there an integration script?\n\n## Fallback\n\nIf Letta Code doesn't support MCP directly, Letta agents will use the tools from issue MXSYN-XXX (file_reservations.py module)\n\n## Parent\n\nBlocked by: Create Letta file_reservations tool module\n\n---\nHuly Issue: MXSYN-55","created_at":"2025-12-26T18:45:13Z"}]}
{"id":"matrix-synapse-deployment-7n8","title":"Fix 12 Letta agents missing Matrix room mappings","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T08:51:39.86412675Z","updated_at":"2026-01-17T22:29:14.155499692-05:00","closed_at":"2026-01-17T22:29:14.155499692-05:00","close_reason":"Closed","labels":["huly:MXSYN-150","huly:MXSYN-172"],"comments":[{"id":49,"issue_id":"matrix-synapse-deployment-7n8","author":"root","text":"## Problem\n\nThe agent room provisioning test discovered 12 Letta agents that don't have Matrix room mappings:\n\n 1. Huly - Huly-Vibe Sync Service (agent-b417b8da-84d2-40dd-97ad-3a35454934f7)\n 2. Test Archival Agent (agent-22273237-8bf9-4a53-8001-fa62aa2469ce)\n 3. Test Archival Agent (agent-36347120-f59c-42fb-bd9a-269b2375f7f2)\n 4. Test Archival Agent (agent-86ec6e54-8fee-4489-abfb-72ba0a3716f4)\n 5. Test Archival Agent (agent-2e3bad24-a040-46ab-af3a-d85496accaca)\n 6. letta-code-agent (agent-22a0d0ec-f156-4738-831b-13bf1cac8bd0)\n 7. letta-cli-agent (agent-64499416-dda3-44a2-8bd8-17193adcc1dc)\n 8. letta-code-agent (agent-06a1cd79-f223-4b38-920a-4f156550123e)\n 9. Meridian-sleeptime (agent-2ee4df6c-59ca-489b-8620-dc53096208ac)\n10. letta-cli-agent (agent-7b751941-abc2-4e23-a0fe-e1e6acd87949)\n11. Huly - Matrix Messaging MCP (agent-ec6b15ef-2f4b-4bae-9ee2-4cea0b22cffd)\n12. letta-cli-agent (agent-5a678a36-64fc-452d-8e7c-d810f21fb15f)\n\n## Impact\n\nWithout room mappings, these agents cannot be reached via  or  operations. The matrix-identity-bridge returns \"no Matrix room configured\" errors.\n\n## Solution\n\nTrigger a manual sync to create rooms for these agents:\n\n\n\nAlternatively, run the provisioning script to create rooms programmatically.\n\n## Verification\n\nRun the test suite:\n\n\n\n---\nHuly Issue: MXSYN-74","created_at":"2025-12-28T08:51:40Z"}]}
{"id":"matrix-synapse-deployment-8r3","title":"Matrix sync client module","description":"Lightweight Matrix client for OpenCode plugin.\n\n## Summary\nA minimal Matrix client module that connects, syncs, and emits filtered room messages. Designed for low overhead per-session usage.\n\n## Requirements\n- Uses identity bridge credentials pattern (folder-derived localpart, registration token, deterministic password)\n- Connects to homeserver, starts sync loop\n- Auto-joins configured rooms on startup\n- Filters to configured rooms only + `m.room.message` with `msgtype: m.text`\n- Handles 429 rate limiting with backoff\n- Emits normalized events: `{roomId, sender, displayName, body, eventId, timestamp}`\n- No history backfill (use `since` token or minimal `initialSyncLimit`)\n\n## Acceptance Criteria\n- [ ] Connects and authenticates using identity bridge pattern\n- [ ] Auto-joins rooms; clear error if forbidden/not invited\n- [ ] Syncs and emits only filtered messages\n- [ ] Respects 429 retry-after\n- [ ] No backlog flood on startup\n- [ ] Clean shutdown on process exit\n\n## Dependencies\n- matrix-synapse-deployment-chq (spec)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T13:37:24.396855748-05:00","updated_at":"2026-01-17T22:28:53.994111325-05:00","closed_at":"2026-01-17T22:28:53.994111325-05:00","close_reason":"Closed","labels":["huly:MXSYN-295","vibe:452f219f-7bbf-44b9-bb5c-c42cd8e76c7f"]}
{"id":"matrix-synapse-deployment-8sq","title":"Create Letta file_reservations tool module","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T18:45:14.337322327Z","updated_at":"2025-12-26T18:45:14.337322327Z","labels":["huly:MXSYN-170","huly:MXSYN-175","huly:MXSYN-176","huly:MXSYN-179","huly:MXSYN-222","huly:MXSYN-224"]}
{"id":"matrix-synapse-deployment-8te7","title":"Deprecation: Remove Identity Logic from TypeScript MCP","description":"## Task\nAfter Python identity system is stable, deprecate and remove identity management from TypeScript MCP.\n\n## Prerequisites\n- [ ] Python identity system fully operational\n- [ ] All consumers migrated to Python API\n- [ ] Migration complete\n- [ ] 2 weeks stable production use\n\n## Phases\n\n### Phase 1: Soft Deprecation\n- Add deprecation warnings\n- Log usage of deprecated endpoints\n- Document migration path\n\n### Phase 2: Hard Deprecation\n- Return 410 Gone for identity operations\n- Remove identity tools from MCP schema\n\n### Phase 3: Removal\n- Delete: identity-manager.ts, client-pool.ts, storage.ts (identity parts)\n- Archive JSON data files\n- Update documentation\n\n## Deliverables\n- [ ] Deprecation warnings added\n- [ ] Migration documentation\n- [ ] Dead code removed\n- [ ] MCP schema updated","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-03T11:05:34.199319062-05:00","updated_at":"2026-01-03T11:05:34.199319062-05:00","labels":["deprecation","huly:MXSYN-189","huly:MXSYN-232"],"dependencies":[{"issue_id":"matrix-synapse-deployment-8te7","depends_on_id":"matrix-synapse-deployment-v6rd","type":"blocks","created_at":"2026-01-03T11:07:09.750130896-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-93b","title":"Implement Matrix file download from media repository","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:32.078603173Z","updated_at":"2026-01-03T11:10:02.057994162-05:00","closed_at":"2026-01-03T11:10:02.057994162-05:00","close_reason":"Duplicate of matrix-synapse-deployment-3162","labels":["huly:MXSYN-264","huly:MXSYN-270","huly:MXSYN-272"],"comments":[{"id":21,"issue_id":"matrix-synapse-deployment-93b","author":"node","text":"## Objective\n\nDownload files from Matrix media repository for processing.\n\n## Implementation\n\n1. Convert  URL to HTTP download URL\n2. Download file with proper authentication\n3. Store temporarily for Docling processing\n4. Clean up after processing complete\n\n## API Reference\n\n\n\n## Acceptance Criteria\n\n- [ ] Successfully download files from mxc:// URLs\n- [ ] Handle authentication correctly\n- [ ] Temporary storage with cleanup\n- [ ] Error handling for failed downloads\n\n---\nHuly Issue: MXSYN-5","created_at":"2025-12-23T03:23:32Z"}]}
{"id":"matrix-synapse-deployment-9c9","title":"Integrate @mention routing into message_callback","description":"## Summary\nWire up the mention extraction and forwarding logic into the main message_callback function so that messages containing @agent mentions are automatically forwarded to the mentioned agents' rooms.\n\n## Location\n`src/matrix/client.py` - `message_callback()` function (around line 1500+)\n\n## Integration Point\nAfter the self-message filter (line ~1544) but before returning, add mention routing:\n\n```python\nasync def message_callback(room, event, config, logger, client):\n    # ... existing code ...\n    \n    # Line ~1542: Filter self-messages\n    if room_agent_user_id and event.sender == room_agent_user_id:\n        logger.debug(f'Ignoring message from room\\'s own agent {event.sender}')\n        \n        # NEW: But first check for @mentions to forward\n        await handle_agent_mention_routing(\n            room=room,\n            event=event,\n            sender_mxid=event.sender,\n            sender_agent_id=room_agent_id,\n            sender_agent_name=room_agent_name,\n            config=config,\n            logger=logger\n        )\n        return  # Still don't process for Letta dispatch\n    \n    # ... rest of existing code ...\n```\n\n## New Handler Function\n```python\nasync def handle_agent_mention_routing(\n    room,\n    event,\n    sender_mxid: str,\n    sender_agent_id: str,\n    sender_agent_name: str,\n    config: Config,\n    logger: logging.Logger\n):\n    \"\"\"\n    Check for @agent mentions and forward message to mentioned agents' rooms.\n    \"\"\"\n    # Skip if already a forwarded message (loop prevention)\n    if hasattr(event, 'source') and isinstance(event.source, dict):\n        content = event.source.get('content', {})\n        if content.get('m.forwarded'):\n            logger.debug('Skipping mention routing for forwarded message')\n            return\n    \n    # Extract mentions\n    mentions = extract_agent_mentions(event.body)\n    if not mentions:\n        return\n    \n    logger.info(f'[MENTION-ROUTING] Found {len(mentions)} agent mentions in message from {sender_agent_name}')\n    \n    for matched_text, target_agent_id, target_agent_name in mentions:\n        # Skip self-mentions\n        if target_agent_id == sender_agent_id:\n            logger.debug(f'Skipping self-mention: {target_agent_name}')\n            continue\n        \n        # Get target room\n        target_mapping = get_mapping_by_agent_id(target_agent_id)\n        if not target_mapping or not target_mapping.get('room_id'):\n            logger.warning(f'[MENTION-ROUTING] No room found for mentioned agent: {target_agent_name}')\n            continue\n        \n        target_room_id = target_mapping['room_id']\n        \n        # Forward the message\n        logger.info(f'[MENTION-ROUTING] Forwarding message from {sender_agent_name} to {target_agent_name} room')\n        \n        event_id = await forward_to_agent_room(\n            source_room_id=room.room_id,\n            target_room_id=target_room_id,\n            message=event.body,\n            sender_mxid=sender_mxid,\n            sender_agent_name=sender_agent_name,\n            target_agent_name=target_agent_name,\n            original_event_id=getattr(event, 'event_id', ''),\n            config=config,\n            logger=logger\n        )\n        \n        if event_id:\n            logger.info(f'[MENTION-ROUTING] Forwarded to {target_agent_name}: {event_id}')\n        else:\n            logger.error(f'[MENTION-ROUTING] Failed to forward to {target_agent_name}')\n```\n\n## Logging\nAdd comprehensive logging for debugging:\n- `[MENTION-ROUTING]` prefix for all related logs\n- Log: mentions found, agents resolved, forwarding attempts, success/failure\n\n## Configuration (Optional)\nConsider adding config flag to enable/disable:\n```\nENABLE_MENTION_ROUTING=true\n```\n\n## Flow Diagram\n```\nAgent sends message with @Meridian\n         ↓\nmessage_callback receives event\n         ↓\nIs sender the room's agent? YES\n         ↓\nhandle_agent_mention_routing()\n         ↓\nextract_agent_mentions('@Meridian')\n         ↓\nResolve: Meridian → agent-597b5756...\n         ↓\nGet Meridian's room: !O8cbkBGCMB8Ujlaret\n         ↓\nforward_to_agent_room()\n         ↓\nMessage appears in Meridian's room\n         ↓\nMeridian's message_callback triggers\n         ↓\nLetta receives message, can respond\n```\n\n## Tests\n- [ ] Agent sends message with @mention → forwarded to target room\n- [ ] Agent sends message without @mention → not forwarded\n- [ ] Agent mentions multiple agents → forwarded to all\n- [ ] Agent mentions itself → not forwarded (skip self)\n- [ ] Forwarded message triggers Letta in target room\n- [ ] Audit trail: messages visible in both rooms\n\n## Dependencies\n- Depends on: matrix-synapse-deployment-21s (name resolution)\n- Depends on: matrix-synapse-deployment-uxj (extract mentions)\n- Depends on: matrix-synapse-deployment-1a3 (forward function)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-16T18:40:08.682789075-05:00","updated_at":"2026-01-17T22:28:53.989017949-05:00","closed_at":"2026-01-17T22:28:53.989017949-05:00","close_reason":"Closed","labels":["feature","huly:MXSYN-320","integration","mention-routing","vibe:0f5e30d5-d84c-4f93-b37e-cfd1a137f208"]}
{"id":"matrix-synapse-deployment-9wy","title":"Document Letta Filesystem API for folder/file operations","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-09T19:36:54.096329344Z","updated_at":"2026-01-10T11:13:12.548690627Z","labels":["huly:MXSYN-200","huly:MXSYN-241"],"comments":[{"id":702,"issue_id":"matrix-synapse-deployment-9wy","author":"root","text":"## Objective\n\nClarify and document Letta Filesystem API endpoints needed for integration.\n\n## API Endpoints to Document\n\n1. **List folders**: \n2. **Create folder**: \n3. **Upload file to folder**: \n4. **Attach folder to agent**: \n5. **Job status**: \n\n## Questions\n\n- How does file chunking work?\n- What embedding model is used by default?\n- How to pass metadata (source, room_id, sender)?\n- Job polling interval for upload completion?\n\n## Deliverable\n\nCode examples or SDK usage documentation\n\n## Reference\n\n- Letta API: https://letta.oculair.ca\n- PRD folder strategy: One folder per Matrix room ()\n\n---\nHuly Issue: MXSYN-3","created_at":"2026-01-09T19:36:54Z"}]}
{"id":"matrix-synapse-deployment-avm","title":"Implement Letta folder management for Matrix rooms","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:31.688159527Z","updated_at":"2026-01-03T11:10:02.064113384-05:00","closed_at":"2026-01-03T11:10:02.064113384-05:00","close_reason":"Duplicate of matrix-synapse-deployment-4esm","labels":["huly:MXSYN-265","huly:MXSYN-274"],"dependencies":[{"issue_id":"matrix-synapse-deployment-avm","depends_on_id":"matrix-synapse-deployment-4esm","type":"related","created_at":"2026-01-03T11:10:02.066229202-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-aykt","title":"Refactor: Webhook Audit to Use Identity-Based Posting","description":"## Task\nRefactor webhook handler to post audit messages using correct Matrix identities.\n\n## Current Behavior\nCombined message from admin account:\n💬 [Direct] Q: ... A: ...\n\n## Desired Behavior\nTwo separate messages:\n1. User's question → Posted with source indicator\n2. Agent's response → Posted by agent's Matrix identity (e.g., @meridian:matrix.oculair.ca)\n\n## Implementation\n1. Extract user message from webhook payload\n2. Look up agent's Matrix identity from database\n3. Post user message to audit room\n4. Post agent response using agent's identity via client pool\n\n## Deliverables\n- [ ] Refactor src/letta/webhook_handler.py\n- [ ] Add identity lookup integration\n- [ ] Use Matrix client pool for agent responses\n- [ ] Unit tests for new logic\n\n## Dependencies\n- js5i (Identity Storage Service)\n- c9me (Matrix Client Pool)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T11:05:05.644951923-05:00","updated_at":"2026-01-11T19:42:49.64761957-05:00","closed_at":"2026-01-11T19:42:49.64762451-05:00","labels":["huly:MXSYN-129","refactor"],"dependencies":[{"issue_id":"matrix-synapse-deployment-aykt","depends_on_id":"matrix-synapse-deployment-js5i","type":"blocks","created_at":"2026-01-03T11:06:49.064384649-05:00","created_by":"root"},{"issue_id":"matrix-synapse-deployment-aykt","depends_on_id":"matrix-synapse-deployment-c9me","type":"blocks","created_at":"2026-01-03T11:06:54.223979452-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-b9mm","title":"Implement: Identity Manager with Synapse Admin API","description":"## Task\nImplement the Identity Manager class that handles user provisioning via Synapse Admin API.\n\n## Requirements\n- Create Matrix users via Synapse Admin API\n- Set display names and avatars\n- Generate and store access tokens\n- Handle user deactivation/reactivation\n\n## API Endpoints Used\n- POST /_synapse/admin/v2/users/{user_id} - Create/update user\n- POST /_synapse/admin/v1/users/{user_id}/login - Get access token\n\n## Reference\nSee TypeScript: mcp-servers/matrix-identity-bridge/src/core/identity-manager.ts\n\n## Deliverables\n- [ ] src/core/identity_manager.py\n- [ ] Synapse Admin API client wrapper\n- [ ] Unit tests with mocked API responses\n\n## Dependencies\n- mybw (Database schema)\n- js5i (Identity Storage Service)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T11:04:36.237482838-05:00","updated_at":"2026-01-17T22:29:14.130155146-05:00","closed_at":"2026-01-17T22:29:14.130155146-05:00","close_reason":"Closed","labels":["huly:MXSYN-132","implementation"],"dependencies":[{"issue_id":"matrix-synapse-deployment-b9mm","depends_on_id":"matrix-synapse-deployment-mybw","type":"blocks","created_at":"2026-01-03T11:06:18.084909302-05:00","created_by":"root"},{"issue_id":"matrix-synapse-deployment-b9mm","depends_on_id":"matrix-synapse-deployment-js5i","type":"blocks","created_at":"2026-01-03T11:06:23.24771838-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-bor","title":"[EPIC] @Mention-Based Inter-Agent Communication Routing","description":"## Overview\nImplement automatic message routing based on @agent mentions in Matrix messages. When an agent mentions another agent (e.g., `@Meridian`), the message should automatically be forwarded to the mentioned agent's room.\n\n## Problem Statement\nCurrently, when Agent A wants to communicate with Agent B:\n1. Agent A must use `talk_to_agent` operation (verbose) OR\n2. Agent A must know Agent B's exact room_id (error-prone)\n\nA recent bug occurred where an agent used `send` with its OWN room_id instead of the target agent's room, causing the message to go to the wrong place.\n\n## Solution\nParse messages for @mentions and automatically forward to mentioned agents' rooms. Messages appear in BOTH rooms for complete audit trail.\n\n## User Stories\n- As an agent, I can mention @Meridian in my message and it will be delivered to Meridian\n- As Emmanuel (admin), I can see the full conversation flow in both agents' rooms\n- As a developer, I can debug inter-agent communication via logs\n\n## Implementation Plan\n\n### Phase 1: Foundation\n- [ ] **matrix-synapse-deployment-21s** - Add agent name resolution by display name\n- [ ] **matrix-synapse-deployment-uxj** - Implement extract_agent_mentions() parser\n\n### Phase 2: Core Feature  \n- [ ] **matrix-synapse-deployment-1a3** - Implement forward_to_agent_room()\n- [ ] **matrix-synapse-deployment-9c9** - Integrate routing into message_callback (P1)\n\n### Phase 3: Polish\n- [ ] **matrix-synapse-deployment-uoa** - Update agent system prompts\n- [ ] **matrix-synapse-deployment-ue9** - Add comprehensive tests\n- [ ] **matrix-synapse-deployment-jov** - Add logging and observability\n\n### Phase 4: Cleanup (Optional)\n- [ ] **matrix-synapse-deployment-2bu** - Rename container to letta-matrix-bridge\n\n## Supported Mention Formats\n1. `@AgentName` - Friendly name (case-insensitive)\n2. `@agent_uuid:matrix.domain` - Full MXID\n\n## Key Behaviors\n- **Dual posting**: Message appears in source room AND target room(s)\n- **Loop prevention**: Forwarded messages marked with `m.forwarded` flag\n- **Self-mention skip**: Agent mentioning itself doesn't trigger forward\n- **Multiple mentions**: One message can forward to multiple agents\n- **Reply handling**: Only parse mentions in new content, not quoted replies\n\n## Success Criteria\n- [ ] Agent can send `@Meridian hello` and Meridian receives it\n- [ ] Message visible in both rooms for audit\n- [ ] No infinite loops from forwarded messages\n- [ ] Comprehensive logging for debugging\n- [ ] Tests pass in CI\n\n## Related Issues\n- matrix-synapse-deployment-21s\n- matrix-synapse-deployment-uxj  \n- matrix-synapse-deployment-1a3\n- matrix-synapse-deployment-9c9\n- matrix-synapse-deployment-uoa\n- matrix-synapse-deployment-ue9\n- matrix-synapse-deployment-jov\n- matrix-synapse-deployment-2bu","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-16T18:42:16.202760667-05:00","updated_at":"2026-01-17T22:28:53.986609614-05:00","closed_at":"2026-01-17T22:28:53.986609614-05:00","close_reason":"Closed","labels":["epic","feature","huly:MXSYN-319","inter-agent","mention-routing"]}
{"id":"matrix-synapse-deployment-c1w","title":"OpenCode ops module for xmcp","description":"Extract opencode_connect/send/notify/status operations into module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:50.697394101-05:00","updated_at":"2026-01-17T22:27:51.968207523-05:00","closed_at":"2026-01-17T22:27:51.968207523-05:00","close_reason":"Closed","labels":["huly:MXSYN-310","vibe:6798141e-9a2e-4d3b-b067-e8c936cced76"]}
{"id":"matrix-synapse-deployment-c9me","title":"Implement: Matrix Client Pool (Python)","description":"## Task\nCreate a Matrix client pool that manages per-identity Matrix clients for sending messages.\n\n## Requirements\n\n### Module: src/matrix/identity_client.py\n\n```python\nclass MatrixClientPool:\n    async def get_client(self, identity_id: str) -\u003e AsyncClient\n    async def get_client_for_mxid(self, mxid: str) -\u003e AsyncClient\n    async def remove_client(self, identity_id: str) -\u003e None\n    async def send_message(\n        self,\n        identity_id: str,\n        room_id: str,\n        content: str,\n        msgtype: str = 'm.text',\n        reply_to: Optional[str] = None\n    ) -\u003e str  # Returns event_id\n    async def send_reaction(self, identity_id: str, room_id: str, event_id: str, emoji: str) -\u003e str\n    async def set_typing(self, identity_id: str, room_id: str, typing: bool, timeout: int = 30000) -\u003e None\n    async def stop_all(self) -\u003e None\n```\n\n### Client Lifecycle\n1. On first request, create AsyncClient with identity's access token\n2. Start client sync (for receiving events)\n3. Cache client in pool\n4. Handle token refresh if needed\n5. Cleanup on removal or shutdown\n\n### Memory Management\n- Max clients in pool: configurable (default 50)\n- LRU eviction for idle clients\n- Idle timeout: 5 minutes\n- Graceful shutdown stops all clients\n\n### Error Handling\n- Token expired → refresh token → retry\n- Rate limited → exponential backoff\n- Client sync failed → restart client\n- Room not joined → auto-join if possible\n\n## Deliverables\n- [ ] MatrixClientPool class implementation\n- [ ] Per-client state storage (sync tokens)\n- [ ] Token refresh mechanism\n- [ ] Memory management with LRU eviction\n- [ ] Unit tests with mocked Matrix server\n- [ ] Integration tests with real Matrix server\n\n## Acceptance Criteria\n- Clients correctly authenticated per identity\n- Messages sent appear from correct user\n- Pool handles 50+ concurrent identities\n- Memory usage stable under load\n- 90%+ test coverage","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T10:57:40.260576419-05:00","updated_at":"2026-01-11T18:39:58.081146123-05:00","closed_at":"2026-01-11T18:39:58.081149449-05:00","labels":["huly:MXSYN-133","implementation"]}
{"id":"matrix-synapse-deployment-chq","title":"Matrix context injector plugin - spec","description":"Inbound-only Matrix integration for OpenCode.\n\n## Summary\nDesign spec for a lightweight OpenCode plugin that injects Matrix room messages into the active session context. This enables CLI agents to receive messages from Letta agents (like Meridian) via Matrix.\n\n## Requirements\n- Reuse folder-derived identity from matrix-identity-bridge (registration token + deterministic password pattern)\n- Subscribe to configured rooms only\n- Inject `m.room.message` events (msgtype `m.text` only) into OpenCode session context\n- Dedupe by `event_id` with TTL cache\n- No backlog/history on startup (start from 'now')\n- Ignore messages from self (loop prevention)\n- Per-folder lockfile prevents dual-session injection conflicts\n\n## Acceptance Criteria\n- [ ] Spec document covers config schema (`.opencode/matrix.yaml`)\n- [ ] Spec defines injection mechanism (same as p2p-bridge.ts)\n- [ ] Spec defines failure modes (401/403/429, not joined, missing config)\n- [ ] Spec defines lockfile behavior (2nd session refuses with clear error)\n- [ ] Spec defines dedupe TTL and reconnect behavior","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T13:37:08.969324072-05:00","updated_at":"2026-01-17T22:28:53.996629158-05:00","closed_at":"2026-01-17T22:28:53.996629158-05:00","close_reason":"Closed","labels":["huly:MXSYN-296","vibe:87db9d4f-fac6-4045-ac5b-ab5765a89af1"]}
{"id":"matrix-synapse-deployment-cvb","title":"Letta ops module for xmcp","description":"Extract letta_send/talk_to_agent/letta_lookup/letta_list/letta_identity operations into module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:45.540245036-05:00","updated_at":"2026-01-17T22:27:51.96597901-05:00","closed_at":"2026-01-17T22:27:51.96597901-05:00","close_reason":"Closed","labels":["huly:MXSYN-311","vibe:67d575c8-0b60-4765-893c-7984482957e3"]}
{"id":"matrix-synapse-deployment-dko","title":"Subscription ops module for xmcp","description":"Extract subscribe/unsubscribe operations into module.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T01:39:30.099438546-05:00","updated_at":"2026-01-16T01:39:30.099438546-05:00","labels":["huly:MXSYN-316","vibe:94076619-a0bc-428f-97ce-a67fa0037beb"]}
{"id":"matrix-synapse-deployment-e2c","title":"Add agent health check to detect stuck approval states","description":"The Houdini MCP agent became unresponsive because it had pending tool approvals that were never processed. The periodic agent sync doesn't detect this state.\n\nProblem:\n- Agent has pending approval_request_message blocking all new messages\n- Matrix bridge keeps forwarding messages but gets CONFLICT errors\n- No automatic recovery - requires manual API call to approve/deny\n\nSolution options:\n1. Add health check in periodic sync to detect agents with pending approvals\n2. Auto-approve or auto-deny stale approval requests (configurable timeout)\n3. Send notification to Matrix when agent is blocked by pending approval\n4. Add /approve and /deny commands to Matrix for manual resolution\n\nRelated: The streaming module now parses approval_request_message but doesn't send approval responses back to Letta yet.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T12:58:08.00041429-05:00","updated_at":"2025-12-28T12:58:08.00041429-05:00","labels":["huly:MXSYN-165","huly:MXSYN-215"]}
{"id":"matrix-synapse-deployment-ele","title":"OpenCode Room Persistence: Bridge loads mappings from disk on startup","description":"Simple fix: Bridge reads the existing JSON room mappings file on startup and populates roomToRegistration map.\n\n**Current State:**\n- Room mappings stored in `mcp-servers/matrix-identity-bridge/data/opencode_room_mappings.json`\n- Bridge doesn't read this file - only gets room info via /update-rooms API call\n- When OpenCode restarts, rooms: [] until talk_to_opencode called\n\n**Fix:**\n1. Mount the JSON file into bridge container (or share via volume)\n2. On bridge startup, read the mappings file\n3. When registration comes in, lookup room by directory from loaded mappings\n4. Populate roomToRegistration map immediately\n\n**File:** `opencode-bridge/src/index.ts`\n\n**Alternative:** Bridge calls MCP API endpoint to get room for directory on registration.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-23T00:12:10.325380756-05:00","created_by":"root","updated_at":"2026-01-23T00:12:10.325380756-05:00","labels":["huly:MXSYN-339"]}
{"id":"matrix-synapse-deployment-go8x","title":"Phase 1: Add webhook endpoint to matrix-identity-bridge","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T16:33:00.341865588Z","updated_at":"2026-01-17T22:29:14.138744523-05:00","closed_at":"2026-01-17T22:29:14.138744523-05:00","close_reason":"Closed","labels":["huly:MXSYN-140","huly:MXSYN-141","huly:MXSYN-143"],"dependencies":[{"issue_id":"matrix-synapse-deployment-go8x","depends_on_id":"matrix-synapse-deployment-lg0a","type":"parent-child","created_at":"2026-01-02T16:33:00.700902884Z","created_by":"unknown"}],"comments":[{"id":366,"issue_id":"matrix-synapse-deployment-go8x","author":"root","text":"Create  endpoint in \n\n- Extract agent_id and messages from payload\n- Look up Matrix room for agent\n- Post response to Matrix room\n- Implement HMAC signature verification\n\n---\nHuly Issue: MXSYN-93","created_at":"2026-01-02T16:33:00Z"}]}
{"id":"matrix-synapse-deployment-gp8","title":"Agent Mail Reverse Bridge: Handle edge cases","description":"## Overview\nHandle edge cases and failure scenarios in the reverse bridge.\n\n## Edge Cases\n1. **Agent sends multiple messages** - Forward all or just first?\n2. **Agent uses tool calls** - Forward tool results or just final response?\n3. **Agent mentions other users** - Preserve mentions?\n4. **Message contains attachments/images** - Forward or skip?\n5. **Rate limiting** - Don't spam Agent Mail\n6. **Duplicate detection** - Don't forward same response twice\n\n## Failure Handling\n- Agent Mail API unavailable → queue and retry\n- Invalid code name mapping → log error, skip\n- Thread_id missing → create new thread or skip?\n\n## Acceptance Criteria\n- [ ] Multi-message responses handled appropriately\n- [ ] Duplicates prevented\n- [ ] Failures logged and recoverable\n- [ ] Rate limiting in place","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-25T11:45:03.655302068-05:00","updated_at":"2025-12-26T18:48:53.979591897Z","labels":["huly:MXSYN-196","huly:MXSYN-238"],"dependencies":[{"issue_id":"matrix-synapse-deployment-gp8","depends_on_id":"matrix-synapse-deployment-ny7","type":"blocks","created_at":"2025-12-25T11:45:38.288079655-05:00","created_by":"daemon"}]}
{"id":"matrix-synapse-deployment-h9d","title":"Enhancement: Add optional room_id to talk_to_opencode","description":"Add optional room_id parameter to talk_to_opencode operation to allow selecting which room to deliver into when an OpenCode instance is active in multiple rooms. Current default behavior (first room) is fine for common case. Suggestion from Meridian.","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-22T17:51:07.240426266-05:00","created_by":"root","updated_at":"2026-01-22T17:51:07.240426266-05:00","labels":["huly:MXSYN-333"]}
{"id":"matrix-synapse-deployment-jbk","title":"Agent Mail Bidirectional Bridge: Architecture decision","description":"## Overview\nDecide where the reverse bridge logic should live.\n\n## Options\n\n### Option A: Extend existing agent_mail_bridge.py\n- Add Matrix listener alongside Agent Mail poller\n- Single container, shared state\n- Simpler deployment\n- Risk: complexity in one service\n\n### Option B: Separate reverse bridge service\n- New container: agent_mail_reverse_bridge\n- Subscribes to Matrix events\n- Calls Agent Mail API independently\n- Cleaner separation of concerns\n- More containers to manage\n\n### Option C: Add to matrix-client\n- matrix-client already processes agent responses\n- Add hook after agent response sent to Matrix\n- Check if original was from bridge, forward if so\n- Least new code, leverages existing flow\n\n## Recommendation\nOption C seems cleanest - matrix-client already has the context.\n\n## Decision Needed\n- [ ] Choose architecture approach\n- [ ] Document rationale","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T11:45:15.322139603-05:00","updated_at":"2025-12-26T18:48:54.69565826Z","labels":["huly:MXSYN-184","huly:MXSYN-227"]}
{"id":"matrix-synapse-deployment-jov","title":"Add logging and observability for @mention routing","description":"## Summary\nAdd comprehensive logging and metrics for the @mention routing feature to support debugging and monitoring in production.\n\n## Logging Requirements\n\n### Log Prefix\nAll mention routing logs should use prefix: `[MENTION-ROUTING]`\n\n### Log Levels\n\n#### INFO Level\n- Mention detected: `[MENTION-ROUTING] Found mention @Meridian in message from Huly - Matrix Synapse Deployment`\n- Forward initiated: `[MENTION-ROUTING] Forwarding to Meridian room !O8cbkBGCMB8Ujlaret`\n- Forward success: `[MENTION-ROUTING] Successfully forwarded to Meridian (event: $abc123)`\n\n#### DEBUG Level\n- Parsing details: `[MENTION-ROUTING] Parsing message body (length: 150)`\n- Resolution details: `[MENTION-ROUTING] Resolved @Meridian -\u003e agent-597b5756...`\n- Skip reasons: `[MENTION-ROUTING] Skipping self-mention`\n- Skip reasons: `[MENTION-ROUTING] Skipping forwarded message (loop prevention)`\n\n#### WARNING Level\n- Unknown agent: `[MENTION-ROUTING] Could not resolve mentioned agent: @UnknownAgent`\n- No room: `[MENTION-ROUTING] Agent Foo has no room configured`\n\n#### ERROR Level\n- Forward failed: `[MENTION-ROUTING] Failed to forward to Meridian: \u003cerror details\u003e`\n- Network errors: `[MENTION-ROUTING] Matrix API error: \u003cdetails\u003e`\n\n### Structured Logging\nUse extra fields for searchability:\n```python\nlogger.info(\n    '[MENTION-ROUTING] Forwarded message',\n    extra={\n        'source_room': source_room_id,\n        'target_room': target_room_id,\n        'sender_agent': sender_agent_name,\n        'target_agent': target_agent_name,\n        'mentions_count': len(mentions),\n        'forward_event_id': event_id\n    }\n)\n```\n\n## Metrics (Optional/Future)\n\n### Counters\n- `mention_routing_forwards_total` - Total forwards attempted\n- `mention_routing_forwards_success` - Successful forwards\n- `mention_routing_forwards_failed` - Failed forwards\n- `mention_routing_mentions_detected` - Total mentions detected\n\n### Labels\n- `source_agent`: Sending agent name\n- `target_agent`: Target agent name\n- `mention_type`: 'mxid' or 'friendly_name'\n\n## Dashboard (Future)\nConsider Grafana dashboard showing:\n- Forward rate over time\n- Success/failure ratio\n- Most active agent-to-agent communication pairs\n- Error trends\n\n## Implementation\n1. Add logging statements to all new functions\n2. Ensure consistent log format\n3. Add extra fields for structured logging\n4. Document log patterns in README\n\n## Testing\n- [ ] Verify logs appear at correct levels\n- [ ] Verify structured fields are present\n- [ ] Test log output doesn't contain sensitive data\n\n## Dependencies\n- After: Core implementation complete","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T18:41:46.217252932-05:00","updated_at":"2026-01-16T18:41:46.217252932-05:00","labels":["huly:MXSYN-324","logging","mention-routing","observability"]}
{"id":"matrix-synapse-deployment-js5i","title":"Implement: Identity Storage Service (Python)","description":"## Task\nCreate the identity storage service that provides CRUD operations for identities.\n\n## Requirements\n\n### Module: src/core/identity_storage.py\n\n```python\nclass IdentityStorage:\n    async def create_identity(self, identity: IdentityCreate) -\u003e Identity\n    async def get_identity(self, identity_id: str) -\u003e Optional[Identity]\n    async def get_identity_by_mxid(self, mxid: str) -\u003e Optional[Identity]\n    async def list_identities(self, type: Optional[str] = None) -\u003e List[Identity]\n    async def update_identity(self, identity_id: str, updates: IdentityUpdate) -\u003e Identity\n    async def delete_identity(self, identity_id: str) -\u003e bool\n    async def touch_identity(self, identity_id: str) -\u003e None  # Update last_used_at\n```\n\n### Features\n- Database-backed with SQLAlchemy async\n- Caching layer for frequent lookups\n- Cache invalidation on writes\n- Bulk operations support\n- Soft delete (is_active flag)\n\n### Caching Strategy\n- LRU cache for identity lookups\n- TTL: 5 minutes for individual identities\n- Invalidate on any write operation\n- Optional Redis backend for distributed caching\n\n## Deliverables\n- [ ] IdentityStorage class implementation\n- [ ] Pydantic models for Identity, IdentityCreate, IdentityUpdate\n- [ ] Cache implementation with invalidation\n- [ ] Unit tests with mocked database\n- [ ] Integration tests with real database\n\n## Acceptance Criteria\n- All CRUD operations work correctly\n- Cache hit rate \u003e 80% for read operations\n- Handles concurrent access safely\n- 95%+ test coverage","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T10:57:15.910871502-05:00","updated_at":"2026-01-11T19:56:53.012329011-05:00","closed_at":"2026-01-11T19:56:53.012340653-05:00","labels":["huly:MXSYN-134","huly:MXSYN-135","implementation"]}
{"id":"matrix-synapse-deployment-kev","title":"Install pre-commit guards for file reservations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T18:45:15.671290989Z","updated_at":"2026-01-17T22:29:14.160317284-05:00","closed_at":"2026-01-17T22:29:14.160317284-05:00","close_reason":"Closed","labels":["huly:MXSYN-153","huly:MXSYN-174"],"comments":[{"id":47,"issue_id":"matrix-synapse-deployment-kev","author":"node","text":"Install Git pre-commit hooks to enforce file reservations and prevent conflicts.\n\n## Tasks\n\n- Install guard for matrix-synapse-deployment repo\n- Test blocking behavior with mock reservations\n- Document guard functionality\n- Create troubleshooting guide\n\n## Command\n\n\n\n## Success Criteria\n\n- Pre-commit hook blocks commits to reserved files\n- Hook allows commits to unreserved files\n- Clear error messages when blocked\n\n## Parent\n\nBlocked by: Configure MCP Agent Mail\n\n---\nHuly Issue: MXSYN-52","created_at":"2025-12-26T18:45:15Z"}]}
{"id":"matrix-synapse-deployment-klh","title":"xmcp scaffolding for matrix-identity-bridge","description":"Add xmcp.config.ts, src/middleware.ts, and src/tools layout for xmcp server.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:38:59.19463287-05:00","updated_at":"2026-01-17T22:27:51.948561543-05:00","closed_at":"2026-01-17T22:27:51.948561543-05:00","close_reason":"Closed","labels":["huly:MXSYN-300","vibe:fac4e996-8f54-4047-83f2-56cf72c99e25"]}
{"id":"matrix-synapse-deployment-kpm","title":"Document MCP Agent Mail integration and workflows","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T18:45:12.557064562Z","updated_at":"2025-12-26T18:45:12.557064562Z","labels":["huly:MXSYN-182","huly:MXSYN-226"],"comments":[{"id":44,"issue_id":"matrix-synapse-deployment-kpm","author":"node","text":"Create comprehensive documentation for the three-layer architecture.\n\n## Documentation Tasks\n\n1. Update AGENTS.md with MCP Agent Mail instructions\n2. Create architecture diagram (Layer 1: Matrix, Layer 2: MCP Agent Mail, Layer 3: Huly)\n3. Write agent onboarding guide\n4. Document file reservation workflow\n5. Create troubleshooting guide\n6. Add examples to README\n\n## Files to Create/Update\n\n-  - Three-layer overview\n-  - How to use reservations\n-  - Add MCP Agent Mail section\n-  - Update with Layer 2 info\n\n## Examples to Include\n\n- OpenCode agent reserving files\n- Letta agent checking for conflicts\n- Multi-agent refactoring workflow\n- Pre-commit guard blocking conflict\n\n## Success Criteria\n\n- New agents can onboard using docs\n- Common issues documented with solutions\n- Architecture clearly explained\n\n## Parent\n\nBlocked by: Create Matrix notification helpers\n\n---\nHuly Issue: MXSYN-58","created_at":"2025-12-26T18:45:12Z"}]}
{"id":"matrix-synapse-deployment-kqz","title":"Add dev mode with auto-reload for matrix-client","description":"After code changes to src/, the matrix-client container needs to be restarted to pick up changes. The source is volume-mounted but Python caches modules.\n\nOptions:\n1. Use watchfiles (already installed) to auto-restart on file changes\n2. Add a dev docker-compose override with watchfiles entrypoint\n3. Create a simple restart script to run after commits\n\nQuick fix for now: docker restart matrix-synapse-deployment-matrix-client-1","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-28T12:50:51.240605877-05:00","updated_at":"2025-12-28T12:50:51.240605877-05:00","labels":["huly:MXSYN-194","huly:MXSYN-235"]}
{"id":"matrix-synapse-deployment-kr2n","title":"Implement: DM Room Management Service","description":"## Task\nImplement DM (Direct Message) room management for identity-based messaging.\n\n## Core Functionality\n- Create DM rooms between two Matrix users\n- Cache room lookups to avoid redundant API calls\n- Support identity-to-identity and identity-to-external-user DMs\n\n## Reference\nSee TypeScript: mcp-servers/matrix-identity-bridge/src/core/storage.ts (getDMRoom, setDMRoom)\n\n## Deliverables\n- [ ] src/matrix/dm_room_service.py\n- [ ] Database operations for dm_rooms table\n- [ ] Unit and integration tests\n\n## Dependencies\n- mybw (Database schema with dm_rooms table)\n- c9me (Matrix Client Pool)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T11:04:59.264619563-05:00","updated_at":"2026-01-17T22:29:14.118596108-05:00","closed_at":"2026-01-17T22:29:14.118596108-05:00","close_reason":"Closed","labels":["huly:MXSYN-130","implementation"],"dependencies":[{"issue_id":"matrix-synapse-deployment-kr2n","depends_on_id":"matrix-synapse-deployment-mybw","type":"blocks","created_at":"2026-01-03T11:06:38.734208967-05:00","created_by":"root"},{"issue_id":"matrix-synapse-deployment-kr2n","depends_on_id":"matrix-synapse-deployment-c9me","type":"blocks","created_at":"2026-01-03T11:06:43.897619076-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-kwlc","title":"Migration: Import Existing Identities from JSON to PostgreSQL","description":"## Task\nCreate migration script to import identities from TypeScript JSON files to PostgreSQL.\n\n## Source Data\n- identities.json: mcp-servers/matrix-identity-bridge/data/identities.json\n- dm_rooms.json: mcp-servers/matrix-identity-bridge/data/dm_rooms.json\n\n## Script Requirements\n1. Read JSON files from TypeScript data directory\n2. Validate data integrity\n3. Transform to PostgreSQL schema format\n4. Insert into database with error handling\n5. Verify migration success\n\n## Deliverables\n- [ ] scripts/migration/migrate_identities.py\n- [ ] Rollback script\n- [ ] Migration verification report\n\n## Risks\n- Access tokens may be expired\n- Duplicate identities across systems","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T11:05:22.95643854-05:00","updated_at":"2026-01-03T11:05:22.95643854-05:00","labels":["huly:MXSYN-157","huly:MXSYN-191","huly:MXSYN-197","migration"],"dependencies":[{"issue_id":"matrix-synapse-deployment-kwlc","depends_on_id":"matrix-synapse-deployment-mybw","type":"blocks","created_at":"2026-01-03T11:06:59.385124951-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-laq","title":"Validate Letta agent flow","description":"Ensure talk_to_agent resolution + auto attach works.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:32.040641927-05:00","updated_at":"2026-01-17T22:28:54.009748661-05:00","closed_at":"2026-01-17T22:28:54.009748661-05:00","close_reason":"Closed","labels":["huly:MXSYN-303","vibe:248eda57-eefd-4fd7-b728-682064b4bb44"]}
{"id":"matrix-synapse-deployment-lg0a","title":"Replace ResponseMonitor Polling with Letta Webhooks","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T16:26:31.820445441Z","updated_at":"2026-01-17T22:29:14.14300172-05:00","closed_at":"2026-01-17T22:29:14.14300172-05:00","close_reason":"Closed","labels":["huly:MXSYN-144","huly:MXSYN-146","huly:MXSYN-151","huly:MXSYN-158"],"comments":[{"id":363,"issue_id":"matrix-synapse-deployment-lg0a","author":"root","text":"## Problem\n\nThe  in  polls Letta every 2 seconds for up to 60 seconds to detect agent responses. This is inefficient:\n\n- ~30 API calls per active conversation\n- Up to 2 second latency before response detection\n- Doesn't scale - polling overhead increases with concurrent conversations\n\n## Solution\n\nLeverage new Letta webhooks ( with messages payload) to replace polling with push notifications.\n\n## Benefits\n\n- API calls: ~30 → 1 per conversation\n- Latency: 0-2 sec → instant\n- Better scalability and simpler code\n\n---\nHuly Issue: MXSYN-92","created_at":"2026-01-02T16:26:32Z"},{"id":447,"issue_id":"matrix-synapse-deployment-lg0a","author":"root","text":"## Bug Fix: Webhook Message Truncation (2026-01-02)\n\n### Problem\nMessages from Letta agents via CLI/API were being severely truncated when posted to Matrix rooms. Instead of full responses, only fragments like `\":\"`, `\"'s happening:\"` appeared.\n\n**Root Cause:** The `extractAssistantContent()` function in `letta-webhook-handler.ts` only handled string content. Letta v1 agents send content in array format:\n```json\n{\"content\": [{\"type\": \"text\", \"text\": \"actual message\"}]}\n```\n\nThe old code fell back to `JSON.stringify()` which produced truncated output.\n\n### Fix Applied\n1. **`letta-webhook-handler.ts`** - Added `extractContentText()` method that properly handles:\n   - String content (direct return)\n   - Array of content parts (extracts `{type: \"text\", text: \"...\"}` entries)\n   - Object with `text` field\n   - Fallback with warning for unknown formats\n\n2. **`webhook-server.ts`** - Improved debug logging to show content type and preview\n\n3. **`tests/webhook-content-extraction.test.ts`** - 25 unit tests covering all content formats and regression tests\n\n### Verification\n- Before: `content length: 1, preview: \":\"`\n- After: `content length: 108, preview: \"Hello! 👋 I received your webhook test message...\"`\n\nAll 25 tests pass. Fix deployed and verified with live webhook.","created_at":"2026-01-02T18:51:33Z"}]}
{"id":"matrix-synapse-deployment-ljd","title":"Config file .opencode/matrix.yaml","description":"Config schema and parser for Matrix context injector.\n\n## Summary\nDefine and implement the config file schema for the Matrix context injector plugin.\n\n## Config Location\n`.opencode/matrix.yaml`\n\n## Schema\n```yaml\n# Required\nhomeserver: https://matrix.oculair.ca\ndefaultRoomId: '!roomId:matrix.oculair.ca'\n\n# Optional\nprojectRooms:\n  project-name: '!roomId:matrix.oculair.ca'\n\n# Optional overrides (usually derived from folder)\n# userId: '@oc_project_v2:matrix.oculair.ca'\n\n# Optional filters (defaults shown)\nfilters:\n  msgtypes:\n    - m.text\n```\n\n## Requirements\n- No secrets in config file (credentials via identity bridge pattern)\n- Reject config if `accessToken` or similar secret fields present\n- Compute `subscribeRooms` from `defaultRoomId` + `projectRooms` values\n- Clear validation errors for missing required fields\n\n## Acceptance Criteria\n- [ ] Plugin reads and parses `.opencode/matrix.yaml`\n- [ ] Missing `homeserver` or `defaultRoomId` produces clear error\n- [ ] Secret fields in config are rejected with warning\n- [ ] Computed `subscribeRooms` list is correct\n\n## Dependencies\n- matrix-synapse-deployment-chq (spec)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T13:37:56.430685693-05:00","updated_at":"2026-01-17T22:28:53.991733759-05:00","closed_at":"2026-01-17T22:28:53.991733759-05:00","close_reason":"Closed","labels":["huly:MXSYN-293","vibe:d78371bb-b858-4cd2-b280-eae1ad3913b1"]}
{"id":"matrix-synapse-deployment-lxyh","title":"Add integration test for duplicate prevention flow","description":"## Context\nEnd-to-end test for the full duplicate prevention flow.\n\n## Requirements\n- Test registration endpoint receives conversation tracking request\n- Test webhook handler checks conversation tracker\n- Test that matrix-direct conversations skip audit\n- Test that external sources get audit posted\n\n## Flow to test\n1. POST /conversations/register with agent_id\n2. POST /webhooks/letta/agent-response with same agent_id\n3. Verify response indicates skip (matrix_direct_skip)\n4. POST /webhooks/letta/agent-response with different agent_id (no registration)\n5. Verify audit was posted\n\n## Files\n- mcp-servers/matrix-identity-bridge/tests/webhook-duplicate-prevention.integration.test.ts (new)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T20:43:06.260084106-05:00","updated_at":"2026-01-02T20:43:06.260084106-05:00","labels":["huly:MXSYN-159","huly:MXSYN-199","huly:MXSYN-205","huly:MXSYN-209","test"]}
{"id":"matrix-synapse-deployment-m4k","title":"Agent Mail Reverse Bridge: Track bridge-originated messages","description":"## Overview\nTrack which Matrix messages originated from the Agent Mail bridge so we can identify when agents respond to them.\n\n## Requirements\n- When bridge sends a message to Matrix, store metadata mapping:\n  - Matrix event_id → Agent Mail message_id\n  - Matrix room_id → Agent Mail recipient (code name)\n  - Original sender (code name)\n- Storage options: in-memory dict, SQLite, or Redis\n- Must survive bridge restarts (persistent storage preferred)\n\n## Acceptance Criteria\n- [ ] Bridge stores mapping when forwarding messages\n- [ ] Mapping includes: matrix_event_id, agent_mail_msg_id, sender, recipient, thread_id\n- [ ] Mapping persists across restarts","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T11:44:36.028601979-05:00","updated_at":"2025-12-26T18:48:54.152449747Z","labels":["huly:MXSYN-188","huly:MXSYN-231"]}
{"id":"matrix-synapse-deployment-mqn","title":"Add xmcp tool metadata for MatrixMessaging","description":"Provide metadata name/description for the xmcp tool.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T01:39:19.821397403-05:00","updated_at":"2026-01-16T01:39:19.821397403-05:00","labels":["huly:MXSYN-301","vibe:c1eaf211-ed1f-465a-9337-ef6047d86064"]}
{"id":"matrix-synapse-deployment-mybw","title":"Design: Python Identity Management Database Schema","description":"## Task\nDesign and implement SQLAlchemy models for identity management.\n\n## Requirements\n\n### New Tables\n\n**identities**\n```sql\nCREATE TABLE identities (\n    id VARCHAR(255) PRIMARY KEY,           -- e.g., letta_agent-xxx, opencode_v2_xxx\n    identity_type VARCHAR(50) NOT NULL,    -- letta, opencode, custom\n    mxid VARCHAR(255) UNIQUE NOT NULL,     -- @user:domain\n    display_name VARCHAR(255),\n    avatar_url VARCHAR(500),               -- mxc:// URL\n    access_token TEXT NOT NULL,            -- Matrix access token\n    password_hash TEXT,                    -- For recovery/re-login\n    device_id VARCHAR(255),                -- Matrix device ID\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n    last_used_at TIMESTAMP,\n    is_active BOOLEAN DEFAULT TRUE\n);\n\nCREATE INDEX idx_identities_type ON identities(identity_type);\nCREATE INDEX idx_identities_mxid ON identities(mxid);\n```\n\n**dm_rooms**\n```sql\nCREATE TABLE dm_rooms (\n    id SERIAL PRIMARY KEY,\n    room_id VARCHAR(255) UNIQUE NOT NULL,\n    participant_1 VARCHAR(255) NOT NULL,   -- Sorted MXIDs\n    participant_2 VARCHAR(255) NOT NULL,\n    created_at TIMESTAMP DEFAULT NOW(),\n    last_activity_at TIMESTAMP,\n    UNIQUE(participant_1, participant_2)\n);\n\nCREATE INDEX idx_dm_rooms_participants ON dm_rooms(participant_1, participant_2);\n```\n\n### Relationships\n- identities.mxid can be referenced by agent_mappings.matrix_user_id\n- dm_rooms links two MXIDs (identities or external users)\n\n## Deliverables\n- [ ] SQLAlchemy models in src/models/identity.py\n- [ ] Alembic migration script\n- [ ] Unit tests for model operations\n- [ ] Documentation of schema\n\n## Acceptance Criteria\n- Models match TypeScript data structure\n- Migration runs without data loss\n- Indexes optimized for common queries\n- Tests cover all CRUD operations","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T10:56:53.85876522-05:00","updated_at":"2026-01-11T19:41:54.551701504-05:00","closed_at":"2026-01-11T19:41:54.551706253-05:00","labels":["database","design","huly:MXSYN-136"]}
{"id":"matrix-synapse-deployment-mzai","title":"Refactor webhook content extraction from MCP to letta-matrix-client","description":"## Background\n\nThe webhook content extraction logic (handling Letta v1 array format `[{type: 'text', text: '...'}]`) is currently in the MCP server (`matrix-identity-bridge`). This is architecturally incorrect - the MCP server should be a tool interface, not handle incoming webhooks from external services.\n\n## Current Location\n- `mcp-servers/matrix-identity-bridge/src/core/letta-webhook-handler.ts`\n- `mcp-servers/matrix-identity-bridge/src/core/webhook-server.ts`\n\n## Target Location\n- `src/letta/letta_matrix_client.py` or similar bridge component\n\n## Changes Required\n1. Move `extractContentText()` logic to Python in the client\n2. Move webhook endpoint handling to the bridge/client\n3. Keep MCP server focused on Matrix messaging operations only\n\n## Content Extraction Logic (for reference)\n```python\ndef extract_content_text(content) -\u003e str | None:\n    if not content:\n        return None\n    if isinstance(content, str):\n        return content\n    if isinstance(content, list):\n        text_parts = []\n        for part in content:\n            if isinstance(part, dict) and part.get('type') == 'text' and isinstance(part.get('text'), str):\n                text_parts.append(part['text'])\n        return '\\n'.join(text_parts) if text_parts else None\n    if isinstance(content, dict) and isinstance(content.get('text'), str):\n        return content['text']\n    return json.dumps(content)\n```","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T15:39:37.280934845-05:00","updated_at":"2026-01-12T00:33:42.08237775-05:00","labels":["huly:MXSYN-163","huly:MXSYN-213"]}
{"id":"matrix-synapse-deployment-nel","title":"Phase 1: Implement Step Streaming Adapter","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-23T03:23:28.561096028Z","updated_at":"2026-01-03T11:10:02.428508107-05:00","closed_at":"2026-01-03T11:10:02.428508107-05:00","close_reason":"Duplicate of matrix-synapse-deployment-10nf","labels":["huly:MXSYN-268","huly:MXSYN-278"]}
{"id":"matrix-synapse-deployment-nh8","title":"Convert MatrixMessaging schema to xmcp format","description":"Split zod schema into xmcp-compatible schema export.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:14.670999232-05:00","updated_at":"2026-01-17T22:27:51.956831022-05:00","closed_at":"2026-01-17T22:27:51.956831022-05:00","close_reason":"Closed","labels":["huly:MXSYN-297","vibe:256b5f82-cd9a-4c4e-806f-8facc0f783e9"]}
{"id":"matrix-synapse-deployment-nqvz","title":"Phase 4: Multi-agent webhook management","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-02T16:26:30.968074932Z","updated_at":"2026-01-02T16:26:30.968074932Z","labels":["huly:MXSYN-192","huly:MXSYN-233"],"dependencies":[{"issue_id":"matrix-synapse-deployment-nqvz","depends_on_id":"matrix-synapse-deployment-lg0a","type":"parent-child","created_at":"2026-01-02T16:28:54.905477916Z","created_by":"unknown"}],"comments":[{"id":362,"issue_id":"matrix-synapse-deployment-nqvz","author":"root","text":"Create utility to:\n- List agents with/without webhooks configured\n- Bulk register webhooks for all Matrix-connected agents\n- Handle webhook secret rotation\n\n---\nHuly Issue: MXSYN-96","created_at":"2026-01-02T16:26:31Z"}]}
{"id":"matrix-synapse-deployment-ny7","title":"Agent Mail Reverse Bridge: Forward replies back to Agent Mail","description":"## Overview\nWhen an agent responds to a bridge message, forward that response back to Agent Mail as a reply.\n\n## Requirements\n- Use Agent Mail `reply_message` API to maintain thread\n- Map Matrix user back to Agent Mail code name\n- Include original context in the reply\n\n## Message Mapping\n- Matrix agent user (@agent_xxx) → Agent Mail code name (WhiteStone, etc)\n- Use existing agent_mail_mappings.json or agent_user_mappings.json\n\n## Reply Format\n- Preserve the agent's response text\n- Include metadata: responded via Matrix, timestamp\n- Maintain thread_id from original message\n\n## Acceptance Criteria\n- [ ] Agent responses forwarded to Agent Mail via reply_message\n- [ ] Thread continuity maintained\n- [ ] Sender correctly mapped to Agent Mail identity\n- [ ] Original sender receives notification","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T11:44:54.558669223-05:00","updated_at":"2025-12-26T18:48:54.520182307Z","labels":["huly:MXSYN-186","huly:MXSYN-228"],"dependencies":[{"issue_id":"matrix-synapse-deployment-ny7","depends_on_id":"matrix-synapse-deployment-t5t","type":"blocks","created_at":"2025-12-25T11:45:38.237330223-05:00","created_by":"daemon"}]}
{"id":"matrix-synapse-deployment-pc3","title":"Remove mcp-framework class usage","description":"Eliminate MCPTool inheritance in favor of xmcp handler function.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T01:40:16.58540746-05:00","updated_at":"2026-01-16T01:40:16.58540746-05:00","labels":["huly:MXSYN-315","vibe:aaf8078d-e27d-4fa2-946c-d4d4b9663184"]}
{"id":"matrix-synapse-deployment-qon","title":"Assemble xmcp tool entrypoint","description":"Create src/tools/matrix-messaging.ts dispatcher with schema/metadata and operation routing.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:11.396701735-05:00","updated_at":"2026-01-17T22:28:36.07861821-05:00","labels":["huly:MXSYN-306","vibe:1ad58148-3971-4fdf-bd96-975811dbe5a7"]}
{"id":"matrix-synapse-deployment-r7e","title":"Configure MCP Agent Mail for coordination-only mode","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T18:45:16.451225956Z","updated_at":"2026-01-17T22:29:14.157948494-05:00","closed_at":"2026-01-17T22:29:14.157948494-05:00","close_reason":"Closed","labels":["huly:MXSYN-152","huly:MXSYN-173"],"comments":[{"id":48,"issue_id":"matrix-synapse-deployment-r7e","author":"node","text":"Configure MCP Agent Mail to focus on file coordination, not messaging (Matrix handles that).\n\n## Configuration\n\n\n\n## Tasks\n\n- Update .env with coordination settings\n- Restart container with new config\n- Verify settings via health endpoint\n- Create first test project\n- Test file reservation API\n\n## Parent\n\nBlocked by: Deploy MCP Agent Mail server\n\n---\nHuly Issue: MXSYN-50","created_at":"2025-12-26T18:45:16Z"}]}
{"id":"matrix-synapse-deployment-rka","title":"xmcp integration tests","description":"Add or run tests for migrated xmcp server.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:37.221706917-05:00","updated_at":"2026-01-17T22:28:54.00755838-05:00","closed_at":"2026-01-17T22:28:54.00755838-05:00","close_reason":"Closed","labels":["huly:MXSYN-302","vibe:3e550c01-1de7-4f27-84dc-852417304a4b"]}
{"id":"matrix-synapse-deployment-roz","title":"Caller context helpers for xmcp","description":"Move caller context and telemetry helpers into core module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:55.886921866-05:00","updated_at":"2026-01-17T22:27:51.970391803-05:00","closed_at":"2026-01-17T22:27:51.970391803-05:00","close_reason":"Closed","labels":["huly:MXSYN-309","vibe:3873ef6c-1914-4f33-8687-c3d052c7a83f"]}
{"id":"matrix-synapse-deployment-rq6s","title":"Phase 2: Register webhooks for Matrix agents","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T16:32:56.751853619Z","updated_at":"2026-01-17T22:29:14.140855153-05:00","closed_at":"2026-01-17T22:29:14.140855153-05:00","close_reason":"Closed","labels":["huly:MXSYN-142","huly:MXSYN-145"],"dependencies":[{"issue_id":"matrix-synapse-deployment-rq6s","depends_on_id":"matrix-synapse-deployment-lg0a","type":"parent-child","created_at":"2026-01-02T16:32:57.091590732Z","created_by":"unknown"}],"comments":[{"id":365,"issue_id":"matrix-synapse-deployment-rq6s","author":"root","text":"For each agent with Matrix room mapping:\n1. Register webhook for  event\n2. Point to webhook endpoint\n3. Configure HMAC secret for verification\n\n---\nHuly Issue: MXSYN-94","created_at":"2026-01-02T16:32:56Z"}]}
{"id":"matrix-synapse-deployment-t5t","title":"Agent Mail Reverse Bridge: Detect agent replies to bridge messages","description":"## Overview\nDetect when a Letta agent responds to a message that came from the Agent Mail bridge.\n\n## Requirements\n- Monitor Matrix rooms for messages from Letta agents\n- Check if the message is a reply (m.relates_to.m.in_reply_to)\n- Look up the replied-to event_id in the bridge tracking store\n- If found, this is a response that needs to be forwarded back\n\n## Detection Logic\n1. Agent posts message in room\n2. Check if message has reply_to event_id\n3. Query tracking store for that event_id\n4. If match found → trigger reverse forward\n\n## Acceptance Criteria\n- [ ] Detect agent replies to bridge messages\n- [ ] Handle both direct replies and thread replies\n- [ ] Ignore agent messages that aren't replies to bridge messages","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T11:44:45.993798812-05:00","updated_at":"2025-12-26T18:48:54.354105777Z","labels":["huly:MXSYN-187","huly:MXSYN-230"],"dependencies":[{"issue_id":"matrix-synapse-deployment-t5t","depends_on_id":"matrix-synapse-deployment-m4k","type":"blocks","created_at":"2025-12-25T11:45:38.181935847-05:00","created_by":"daemon"}]}
{"id":"matrix-synapse-deployment-tbk","title":"Houdini MCP room missing matrix-client bot","description":"The Houdini MCP agent room (!TctV8CNuX9S0Q0OyQh:matrix.oculair.ca) is missing @oc_matrix_synapse_deployment:matrix.oculair.ca which is needed to forward messages to Letta. Compare to Meridian room which has this user. Need to invite the bot to the room.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T12:10:26.544770679-05:00","updated_at":"2026-01-17T22:29:14.144951815-05:00","closed_at":"2026-01-17T22:29:14.144951815-05:00","close_reason":"Closed","labels":["huly:MXSYN-148","huly:MXSYN-162"]}
{"id":"matrix-synapse-deployment-tgr","title":"Investigate why agent sync misses some Letta agents","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T08:52:02.61596291Z","updated_at":"2026-01-17T22:29:14.153143276-05:00","closed_at":"2026-01-17T22:29:14.153143276-05:00","close_reason":"Closed","labels":["huly:MXSYN-149","huly:MXSYN-164","huly:MXSYN-171"]}
{"id":"matrix-synapse-deployment-ttd1","title":"Epic: Migrate Identity Management from TypeScript to Python","description":"## Overview\nRefactor the identity management and message routing logic from the TypeScript MCP (matrix-identity-bridge) into the Python matrix-api service. This centralizes identity operations and exposes them as a REST API that other services can consume.\n\n## Goals\n1. Single source of truth for identity management in Python\n2. REST API for all identity operations\n3. Proper database-backed storage (PostgreSQL)\n4. Matrix client pool for identity-based message sending\n5. Comprehensive test coverage (unit + integration)\n6. Backward compatibility during transition\n\n## Current State (TypeScript)\n- JSON file storage (identities.json, dm_rooms.json)\n- @vector-im/matrix-bot-sdk for Matrix clients\n- Per-identity client pool with caching\n- Synapse Admin API integration for user provisioning\n- Identity types: letta, opencode, custom\n\n## Target State (Python)\n- PostgreSQL database with SQLAlchemy ORM\n- matrix-nio for Matrix clients\n- FastAPI REST endpoints\n- Shared with existing agent_mapping tables\n- Same identity types + extensible\n\n## Success Criteria\n- [ ] All identity CRUD operations work via Python API\n- [ ] Messages can be sent AS specific identities\n- [ ] Webhook audit posts use correct agent identity\n- [ ] 90%+ test coverage on new code\n- [ ] TypeScript MCP can be deprecated for identity ops\n\n## Dependencies\n- PostgreSQL database access\n- Matrix homeserver (Tuwunel)\n- Synapse Admin API token\n- matrix-nio library\n\n## Risks\n- Data migration from JSON to PostgreSQL\n- Access token refresh handling\n- Client pool memory management\n- Breaking changes to MCP consumers","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T10:56:28.139583653-05:00","updated_at":"2026-01-17T22:29:14.132171506-05:00","closed_at":"2026-01-17T22:29:14.132171506-05:00","close_reason":"Closed","labels":["epic","huly:MXSYN-137","refactor"]}
{"id":"matrix-synapse-deployment-ue9","title":"Add tests for @mention-based agent routing","description":"## Summary\nCreate comprehensive tests for the @mention routing feature to ensure reliability and prevent regressions.\n\n## Test Categories\n\n### 1. Unit Tests - extract_agent_mentions()\n\n```python\n# test_mention_parser.py\n\ndef test_extract_mxid_mention():\n    body = 'Hello @agent_597b5756_2915_4560_ba6b_91005f085166:matrix.oculair.ca how are you?'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 1\n    assert mentions[0][1] == 'agent-597b5756-2915-4560-ba6b-91005f085166'\n\ndef test_extract_friendly_name_mention():\n    body = 'Hey @Meridian can you help?'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 1\n    assert mentions[0][2] == 'Meridian'\n\ndef test_extract_multiple_mentions():\n    body = '@Meridian and @BMO please collaborate'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 2\n\ndef test_no_mentions():\n    body = 'Just a regular message'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 0\n\ndef test_strip_reply_fallback():\n    body = '''\u003e \u003c@user:matrix.org\u003e @Meridian old mention\n\u003e quoted content\n\n@BMO this is the new message'''\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 1\n    assert mentions[0][2] == 'BMO'  # Only new message mention\n\ndef test_unknown_agent_name():\n    body = '@NonExistentAgent hello'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 0  # Unknown agent filtered out\n\ndef test_case_insensitive_name():\n    body = '@meridian @MERIDIAN @Meridian'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 1  # Deduplicated\n\ndef test_huly_prefix_handling():\n    body = '@Matrix Synapse Deployment hello'  # Matches 'Huly - Matrix Synapse Deployment'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 1\n```\n\n### 2. Unit Tests - forward_to_agent_room()\n\n```python\n# test_forward.py\n\n@pytest.mark.asyncio\nasync def test_forward_message_success():\n    # Mock Matrix client\n    # Verify message sent to target room\n    # Verify correct attribution format\n    pass\n\n@pytest.mark.asyncio  \nasync def test_forward_sets_forwarded_flag():\n    # Verify m.forwarded = True in content\n    pass\n\n@pytest.mark.asyncio\nasync def test_forward_includes_source_reference():\n    # Verify m.forward_source contains original event info\n    pass\n```\n\n### 3. Integration Tests - Full Flow\n\n```python\n# test_mention_routing_integration.py\n\n@pytest.mark.asyncio\nasync def test_agent_mention_triggers_forward():\n    '''\n    Simulate: Agent A sends message with @AgentB\n    Verify: Message appears in Agent B's room\n    '''\n    pass\n\n@pytest.mark.asyncio\nasync def test_forwarded_message_triggers_letta():\n    '''\n    Verify: Forwarded message in Agent B's room\n    triggers Letta API call for Agent B\n    '''\n    pass\n\n@pytest.mark.asyncio\nasync def test_loop_prevention():\n    '''\n    Verify: Forwarded messages with m.forwarded flag\n    are not re-forwarded\n    '''\n    pass\n\n@pytest.mark.asyncio\nasync def test_self_mention_not_forwarded():\n    '''\n    Verify: Agent mentioning itself doesn't trigger forward\n    '''\n    pass\n\n@pytest.mark.asyncio\nasync def test_multiple_mentions_all_forwarded():\n    '''\n    Verify: @A @B @C message forwards to all three rooms\n    '''\n    pass\n```\n\n### 4. Edge Case Tests\n\n```python\ndef test_mention_in_code_block():\n    body = '```\\n@Meridian\\n```'\n    # Decide: should this be extracted or not?\n    \ndef test_email_like_pattern_not_matched():\n    body = 'Contact me at agent@example.com'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 0\n\ndef test_partial_mxid_not_matched():\n    body = '@agent_partial not a full mxid'\n    mentions = extract_agent_mentions(body)\n    assert len(mentions) == 0  # No domain = not valid\n```\n\n## Test Infrastructure\n- [ ] Add pytest fixtures for mock agent mappings\n- [ ] Add fixtures for mock Matrix client\n- [ ] Add fixtures for mock Letta responses\n\n## CI Integration\n- [ ] Add tests to existing test workflow\n- [ ] Ensure tests run on PR\n\n## Coverage Targets\n- extract_agent_mentions: 100% line coverage\n- forward_to_agent_room: 90%+ coverage\n- Integration paths: Key happy paths covered\n\n## Dependencies\n- After: All implementation issues complete","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-16T18:41:18.445614883-05:00","updated_at":"2026-01-16T18:41:18.445614883-05:00","labels":["huly:MXSYN-325","mention-routing","testing","vibe:6e2110a0-fe8a-4307-8627-d98588564bb8"]}
{"id":"matrix-synapse-deployment-uoa","title":"Update agent system prompts to use @mention pattern for inter-agent communication","description":"## Summary\nUpdate Letta agent system prompts/instructions to encourage using @AgentName mentions when communicating with other agents, rather than specifying room_ids manually.\n\n## Current Problem\nAgents use the `matrix_messaging` tool with:\n- `talk_to_agent` operation (correct but verbose)\n- `send` operation with explicit room_id (error-prone - easy to use wrong room)\n\nExample of the bug that happened:\n```json\n{\n  \"operation\": \"send\",\n  \"room_id\": \"!MtuqLUCwvKypRU6gll:matrix.oculair.ca\",  // THIS IS THEIR OWN ROOM\n  \"message\": \"Response to Meridian...\"\n}\n```\n\n## Proposed Pattern\nAgents should simply include @mentions in their messages:\n```json\n{\n  \"operation\": \"send\",\n  \"room_id\": \"!MtuqLUCwvKypRU6gll:matrix.oculair.ca\",  // Their own room is fine\n  \"message\": \"@Meridian Here is my response to your question...\"\n}\n```\n\nThe bridge will:\n1. Post the message in the sending agent's room (audit trail)\n2. Automatically forward to Meridian's room (routing)\n3. Meridian receives it and can respond\n\n## System Prompt Updates\n\n### For All Agents\nAdd to base system prompt:\n```\n## Inter-Agent Communication\n\nWhen you need to send a message to another agent:\n\n1. **Preferred Method**: Include @AgentName in your message\n   - Example: \"@Meridian Can you help me with this task?\"\n   - The bridge will automatically forward your message to that agent's room\n   - Your message will appear in BOTH your room and their room (audit trail)\n\n2. **Supported mention formats**:\n   - @Meridian (friendly name)\n   - @BMO (friendly name)  \n   - @agent_597b5756_2915_4560_ba6b_91005f085166:matrix.oculair.ca (full MXID)\n\n3. **Multiple agents**: You can mention multiple agents in one message\n   - \"@Meridian @BMO Please review this together\"\n\n4. **Avoid**: Using the 'send' operation with another agent's room_id directly\n   - This bypasses proper routing and audit trails\n```\n\n### For Huly Project Agents\n```\nWhen reporting to or communicating with other project agents:\n- Use @AgentName mentions in your messages\n- Example: \"@Meridian Completed task MXSYN-123: implemented feature X\"\n```\n\n## Where to Update\n\n1. **Letta Agent Core Memory/Persona blocks** - for persistent agents\n2. **AGENTS.md files** - for OpenCode/Claude Code instructions\n3. **Tool descriptions** - update matrix_messaging tool description\n\n## Tool Description Update\nUpdate the `matrix_messaging` tool description to include:\n```\n## Inter-Agent Communication\n\nTo message another agent, simply include @AgentName in your message.\nThe bridge will automatically forward to their room.\n\nExample:\n{\n  \"operation\": \"send\", \n  \"room_id\": \"your-room-id\",\n  \"message\": \"@Meridian Here is the information you requested...\"\n}\n```\n\n## Rollout\n- [ ] Update tool description in MCP server\n- [ ] Update 2-3 key agents' system prompts as pilot\n- [ ] Monitor for correct usage\n- [ ] Roll out to all agents\n\n## Success Criteria\n- Agents naturally use @mentions for inter-agent communication\n- Messages appear in both rooms for audit\n- No more \"message sent to wrong room\" bugs\n\n## Dependencies\n- Depends on: @mention routing implementation complete\n- After: matrix-synapse-deployment-9c9","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T18:40:43.559232248-05:00","updated_at":"2026-01-17T22:28:54.005095121-05:00","closed_at":"2026-01-17T22:28:54.005095121-05:00","close_reason":"Closed","labels":["agents","documentation","huly:MXSYN-321","ux","vibe:693dd632-5f18-42ac-9542-aa564ffc5515"]}
{"id":"matrix-synapse-deployment-uxj","title":"Implement extract_agent_mentions() function for parsing @mentions","description":"## Summary\nCreate a function to extract agent @mentions from Matrix message bodies, supporting both MXID format and friendly agent names.\n\n## Location\n`src/matrix/client.py` (or new module `src/matrix/mention_parser.py`)\n\n## Function Signature\n```python\nfrom typing import List, Tuple, Optional\n\ndef extract_agent_mentions(body: str) -\u003e List[Tuple[str, str, str]]:\n    \"\"\"\n    Extract @agent mentions from message body.\n    \n    Args:\n        body: The message body text\n        \n    Returns:\n        List of (matched_text, agent_id, agent_name) tuples\n        - matched_text: The original mention string found\n        - agent_id: Resolved Letta agent ID\n        - agent_name: Agent display name\n    \"\"\"\n```\n\n## Patterns to Match\n\n### 1. Full MXID Pattern\n`@agent_[uuid_with_underscores]:matrix.domain`\n- Example: `@agent_597b5756_2915_4560_ba6b_91005f085166:matrix.oculair.ca`\n- Regex: `@agent_[a-f0-9_]+:[a-z0-9._-]+`\n\n### 2. Friendly Name Pattern  \n`@AgentName` (word boundary, case-insensitive)\n- Example: `@Meridian`, `@BMO`, `@GraphitiExplorer`\n- Must resolve via `get_mapping_by_agent_name()`\n- Handle multi-word names: `@Matrix Synapse Deployment` (tricky - may need quotes or camelCase)\n\n## Important: Strip Reply Fallback\nMatrix replies include quoted content. Must extract mentions only from NEW message, not quoted text.\n\n```python\n# Strip Matrix reply fallback format:\n# \u003e \u003c@user:domain\u003e original message\n# \u003e continued quote\n#\n# Actual new message here\n\ndef strip_reply_fallback(body: str) -\u003e str:\n    \"\"\"Remove Matrix reply quoted content, keep only new message\"\"\"\n    lines = body.split('\\n')\n    if not lines[0].startswith('\u003e '):\n        return body\n    # Find first non-quote line after blank line\n    for i, line in enumerate(lines):\n        if i \u003e 0 and line == '' and lines[i-1].startswith('\u003e'):\n            return '\\n'.join(lines[i+1:])\n    return body\n```\n\n## Resolution Flow\n1. Strip reply fallback\n2. Find all @mentions via regex\n3. For each mention:\n   - If MXID format → `get_mapping_by_matrix_user()`\n   - If name format → `get_mapping_by_agent_name()`\n4. Return list of resolved agents (skip unresolved)\n\n## Edge Cases\n- [ ] Self-mention (agent mentions itself) - include but flag\n- [ ] Unknown agent name - log warning, skip\n- [ ] Multiple mentions of same agent - deduplicate\n- [ ] Mention in code block - should we skip? (probably not for MVP)\n- [ ] Partial name match ambiguity - log, pick first/best\n\n## Tests\n- [ ] Single MXID mention\n- [ ] Single name mention  \n- [ ] Multiple mentions (mixed types)\n- [ ] Reply with mentions in quote AND new text - only extract from new\n- [ ] No mentions returns empty list\n- [ ] Invalid/unknown mention logs warning\n\n## Dependencies\n- Depends on: matrix-synapse-deployment-21s (agent name resolution)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T18:39:00.16962608-05:00","updated_at":"2026-01-17T22:28:54.002658542-05:00","closed_at":"2026-01-17T22:28:54.002658542-05:00","close_reason":"Closed","labels":["feature","huly:MXSYN-323","mention-routing","vibe:1342da3f-9ffc-4850-862c-0b285df4bf83"]}
{"id":"matrix-synapse-deployment-v6rd","title":"Testing: Comprehensive Test Suite for Identity System","description":"## Task\nCreate comprehensive unit and integration tests for Python identity system. Target: 90%+ coverage.\n\n## Unit Tests\n- Identity Storage Service (CRUD operations)\n- Identity Manager (Synapse Admin API)\n- Matrix Client Pool (caching, refresh)\n- DM Room Service (create, lookup)\n\n## Integration Tests\n- API endpoint lifecycle tests\n- Send message as identity flow\n- Error response handling\n\n## End-to-End\n- Create identity → send message → verify in Matrix\n- Webhook → posts with correct identity\n\n## Deliverables\n- [ ] tests/unit/test_identity_storage.py\n- [ ] tests/unit/test_identity_manager.py\n- [ ] tests/unit/test_client_pool.py\n- [ ] tests/unit/test_dm_room_service.py\n- [ ] tests/integration/test_identity_api.py\n- [ ] Coverage report showing 90%+","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T11:05:28.179741762-05:00","updated_at":"2026-01-03T11:05:28.179741762-05:00","labels":["huly:MXSYN-156","huly:MXSYN-185","huly:MXSYN-190","test"],"dependencies":[{"issue_id":"matrix-synapse-deployment-v6rd","depends_on_id":"matrix-synapse-deployment-5wcc","type":"blocks","created_at":"2026-01-03T11:07:04.545106509-05:00","created_by":"root"}]}
{"id":"matrix-synapse-deployment-vg1","title":"Add streaming support for approval_request_message","description":"The streaming.py module doesn't handle approval_request_message types from Letta. When an agent requires tool approval, this message type is ignored (logged as 'Unknown message type'). Need to:\n1. Add handling for approval_request_message in _parse_chunk() - DONE in this session\n2. Display approval requests in Matrix room so users/OpenCode can see what needs approval\n3. Implement a way to send approval responses back to Letta via Matrix commands (e.g., /approve, /deny)\n4. Test with agents that have tools requiring approval (like Houdini MCP with Bash tool)\n\nPartial implementation committed in streaming.py but not tested yet.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T12:10:41.266274726-05:00","updated_at":"2025-12-28T12:16:30.285514964-05:00","labels":["huly:MXSYN-166","huly:MXSYN-217"]}
{"id":"matrix-synapse-deployment-vyw","title":"OpenCode Room Persistence: Add API endpoints for room CRUD","description":"Add REST endpoints to matrix-api for OpenCode room mappings.\n\n**Endpoints:**\n- `GET /opencode/{directory_b64}/room` - Get room for directory (b64 encoded path)\n- `POST /opencode/rooms` - Create/update room mapping\n- `GET /opencode/rooms` - List all OpenCode room mappings\n- `DELETE /opencode/{directory_b64}/room` - Delete room mapping\n\n**Request/Response:**\n```json\n{\n  \"directory\": \"/opt/stacks/project\",\n  \"room_id\": \"!abc123:matrix.oculair.ca\",\n  \"identity_id\": \"opencode_v2_xxx\",\n  \"identity_mxid\": \"@oc_project_v2:matrix.oculair.ca\"\n}\n```\n\n**Depends on:** matrix-synapse-deployment-44n (DB table)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-23T00:03:56.163348364-05:00","created_by":"root","updated_at":"2026-01-23T00:12:25.909086535-05:00","closed_at":"2026-01-23T00:12:25.909086535-05:00","close_reason":"Superseded by simpler disk-based approach: matrix-synapse-deployment-ele","labels":["huly:MXSYN-336","vibe:16edfb09-895d-47dd-a8b0-54159d5dbe7c"]}
{"id":"matrix-synapse-deployment-xf5","title":"Messaging ops module for xmcp","description":"Extract send/read/react/edit/typing operations into module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:39:24.956364068-05:00","updated_at":"2026-01-17T22:27:51.959064986-05:00","closed_at":"2026-01-17T22:27:51.959064986-05:00","close_reason":"Closed","labels":["huly:MXSYN-314","vibe:0fe1c390-54fe-4b99-afe9-bca89b374972"]}
{"id":"matrix-synapse-deployment-xru","title":"Agent room provisioning helpers for xmcp","description":"Move agent mapping and room provisioning helpers into core module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:01.064001113-05:00","updated_at":"2026-01-17T22:28:28.387286738-05:00","closed_at":"2026-01-17T22:28:28.387286738-05:00","close_reason":"Closed","labels":["huly:MXSYN-308","vibe:42fadb42-63dc-4e31-bf0f-8d0a1e555e46"]}
{"id":"matrix-synapse-deployment-yam","title":"OpenCode auto-registration helper for xmcp","description":"Move autoRegisterWithBridge into core helper module.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:06.238364953-05:00","updated_at":"2026-01-17T22:28:28.391522444-05:00","closed_at":"2026-01-17T22:28:28.391522444-05:00","close_reason":"Closed","labels":["huly:MXSYN-307","vibe:d7399f6b-ea97-4ffa-9626-92b968959da5"]}
{"id":"matrix-synapse-deployment-zcz","title":"Verify tool context parity","description":"Ensure getToolContext + services available in xmcp.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T01:40:21.726740259-05:00","updated_at":"2026-01-17T22:28:28.396491063-05:00","closed_at":"2026-01-17T22:28:28.396491063-05:00","close_reason":"Closed","labels":["huly:MXSYN-305","vibe:4c435712-da30-4b6f-989e-245b585418ea"]}
